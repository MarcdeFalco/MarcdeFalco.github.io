<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="generator" content="pandoc">
    <meta name="description" content="">
    <meta name="author" content="Marc de Falco">

    <title>Dungeons&amp;Diagrams</title>

    <link rel="stylesheet" type="text/css" href="assets/semantic.min.css">
    <link href='//fonts.googleapis.com/css?family=Lato:300,400' rel='stylesheet' type='text/css'>
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-PHZQE2FC4W"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-PHZQE2FC4W');
	</script>

    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>
    <script src="assets/semantic.min.js"></script>

    <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    </style>
  <script
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
  type="text/javascript"></script>

<script>
$(document).ready(function() {
    
    $("#toc").sidebar("setting", "dimPage", false);
    $("#toc").sidebar("setting", "delaySetup", true);

   $('.ui.accordion').accordion();
    if (matchMedia) {
        var mq = window.matchMedia("(max-width: 900px)");
        mq.addListener(big_or_small);
        big_or_small(mq);
    }

    $("[href^='#']").click(
        () => {
            if (! $("#main").hasClass('shrink')) {
	            $("#toc").sidebar("hide");
            }
        })

    function big_or_small(mq) {
        // The sidebar *pushes* the pusher, the main content, so we
        // add a class that reduces the pusher's width so the edge
        // content isn't cut off.
        if (mq.matches) {
	        $("#toc").sidebar("hide");
            $("#main").removeClass("shrink")
        } else {
            $("#toc").sidebar("show");
            $("#main").addClass("shrink");
        }
    }

    $("#sidebar-menu-button").click(function() {
        $("#toc").sidebar("show");
    }).end();

    $('.tabular.menu .item').tab({
            context: 'parent'
        });

})

function setLang(l) {
    $('.tabular.menu .item').removeClass("active")
    $('.tabular.menu .item[data-tab^="'+l+'"]').addClass("active")
    $('.code').removeClass("active")
    $('.code[data-tab^="'+l+'"]').addClass("active")
}
</script>

  <style type="text/css">

  .ui.sidebar {
    font-size: 15px;
  }

  body {
    background-color: #FFFFFF;
    font-size: 20px;
  }
  .ui.segment {
    font-size: 20px;
  }
  .wireframe {
    //margin-top: 2em;
  }
  .ui.footer.segment {
    //margin: 5em 0em 0em;
    //padding: 5em 0em;
  }
  #top-menu {
    display: none;
    }

    .message {
        color: #000 !important;
    }

.shrink {
    width: 60%;
}

.code {
    font-size: 0.8em !important;
}

table {
    margin-left: auto;
    margin-right: auto;
    margin-bottom: 24px;
    border-spacing: 0;
    border-bottom: 2px solid black;
    border-top: 2px solid black;
}

table tr {
    display: table-row !important;
}

table th {
    padding: 3px 10px;
    background-color: white;
    border-top: none;
    border-left: none;
    border-right: none;
    border-bottom: 1px solid black;
}
table td {
    padding: 3px 10px;
    border-top: none;
    border-left: none;
    border-bottom: none;
    border-right: none;
}

.ui.styled.accordion {
    width: 100% !important;
    font-size: 1rem !important;
}

  .menu .item {
      padding: .5em 1em !important;
  }

@media only screen and (max-width: 900px) {
    .ui.image, .ui.image img {
        display: block;
        //width: 100%;
        width: auto;
        height: auto;
    }

    #top-menu {
        display: block !important;
    }
}
  </style>

  </head>
  <body class="pushable class="pushable"">
<div style="display: none;">
\(
\def\N{{\mathbb{N}}}
\def\R{{\mathbb{R}}}
\def\D{{\mathbb{D}}}
\def\C{{\mathbb{C}}}
\def\Z{{\mathbb{Z}}}
\def\Q{{\mathbb{Q}}}
\def\K{{\mathbb{K}}}
\def\KX{{\mathbb{K}}[X]}
\def\U{{\mathbb{U}}}
\def\B{{\mathcal{B}}}
\newcommand\ensfonctions[2]{\mathcal{F}(#1,#2)}
\newcommand\classeck[3]{\mathcal{C}^{#1}(#2,#3)}
\newcommand\range[2]{[| #1,#2 |]}
\newcommand\mod[0]{\mathop{mod}}
\newcommand\land[0]{\mathop{land}}
\newcommand\matrices[3]{\mathcal{M}_{#1,#2}(#3)}
\newcommand\matricescarres[2]{\mathcal{M}_{#1}(#2)}
\newcommand\gln[2]{\mbox{GL}_{#1}(#2)}
\newcommand\Support[1]{\mbox{Supp}(#1)}
\newcommand\dom[0]{\mbox{dom}}
\newcommand\uniondisjointe{\sqcup}
\def\lt{<}
\def\rR{\mathcal{R}}
\newcommand\parties[1]{\mathcal{P}(#1)}
\newcommand\entiere[1]{\left\lfloor #1 \right\rfloor}
\newcommand\congru[3]{#1 = #2\ [#3]}
\newcommand\enscomp[2]{\left\{\left.\ #1\ \right|\ #2\ \right\}}
\newcommand\classe[1]{\overline{#1}}
\newcommand\classemod[2]{\overline{#1}^{[#2]}}
\newcommand\quotient[2]{#1 / #2}
\newcommand\ZnZ[1]{\quotient{\Z}{#1 \Z}}
\newcommand\card[1]{\text{Card}\ #1}
\newcommand\indic{\mathbbm{1}}
\newcommand\id{\mbox{id}}
\newcommand\gO{\mathcal{O}}
\newcommand\Perm[1]{\mathfrak{S}_#1}
\newcommand\comb[2]{\binom{#1}{#2}}
\newcommand\tend[2]{\xrightarrow[#1 \rightarrow #2]{}}
\newcommand\limite[2]{\lim_{#1 \rightarrow #2}}
\newcommand\application[5]{\begin{array}{rcccc}
#1 & : & #2 & \mapsto & #3 \\ 
& & #4 & \mapsto & #5
\end{array}}
\)
</div>



<div class="ui vertical inverted visible fixed sidebar menu" id="toc">
    <div class="item">
    <a href="/">
        <i class="icon home"></i> Informatique en CPGE
    </a>
    </div>
    <div class="item">
        <div class="ui buttons compact">
            <button onClick="setLang('ocaml')" class="ui button compact">OCaml</button>
            <button onClick="setLang('c')" class="ui button compact">C</button>
            <button onClick="setLang('python')" class="ui button compact">Python</button>
        </div>
        <div>Langage des exemples</div>
    </div>
    <div class="item">
    <a href="#">
        Dungeons&amp;Diagrams
    </a>
    </div>
<!-- FIX TOC -->
<div class="item header"> <a href="#sec:pr√©sentation-du-probl√®me-et-de-la-r√©solution"><span>1</span> Pr√©sentation du probl√®me et de la r√©solution</a><div class="menu"><a class="item" href="#sec:dd"><div class="ui label">1.1</div> D&amp;D</a><a class="item" href="#sec:repr√©sentation-des-plateaux-en-64bit"><div class="ui label">1.2</div> Repr√©sentation des plateaux en 64bit</a><a class="item" href="#sec:repr√©sentation-du-probl√®me"><div class="ui label">1.3</div> Repr√©sentation du probl√®me</a><a class="item" href="#sec:choix-pour-le-backtracking"><div class="ui label">1.4</div> Choix pour le backtracking</a></div></div><div class="item header"> <a href="#sec:op√©rations-bit-√†-bit-en-c"><span>2</span> Op√©rations bit √† bit en C</a><div class="menu"><a class="item" href="#sec:op√©rateurs-de-d√©calage"><div class="ui label">2.1</div> Op√©rateurs de d√©calage</a><a class="item" href="#sec:op√©rateurs-logiques"><div class="ui label">2.2</div> Op√©rateurs logiques</a><a class="item" href="#sec:popcount"><div class="ui label">2.3</div> Popcount</a><div class="secondary menu"><a style="font-size:0.6em" class="item" href="#sec:calcul-na√Øf"><i class="circle icon"></i> Calcul na√Øf</a><a style="font-size:0.6em" class="item" href="#sec:calcul-par-masquage-et-additions"><i class="circle icon"></i> Calcul par masquage et additions</a><a style="font-size:0.6em" class="item" href="#sec:instruction-assembleur"><i class="circle icon"></i> Instruction assembleur</a></div></div></div><div class="item header"> <a href="#sec:squelette-du-backtracking"><span>3</span> Squelette du backtracking</a><div class="menu"></div></div><div class="item header"> <a href="#sec:impl√©mentation-des-diff√©rentes-v√©rifications"><span>4</span> Impl√©mentation des diff√©rentes v√©rifications</a><div class="menu"><a class="item" href="#sec:tests-pour-les-colonnes"><div class="ui label">4.1</div> Tests pour les colonnes</a><a class="item" href="#sec:impasses"><div class="ui label">4.2</div> Impasses</a><div class="secondary menu"><a style="font-size:0.6em" class="item" href="#sec:carr√©s-libres"><i class="circle icon"></i> Carr√©s libres</a><a style="font-size:0.6em" class="item" href="#sec:salles-au-tr√©sor"><i class="circle icon"></i> Salles au tr√©sor</a></div></div></div><div class="item header"> <a href="#sec:exemples"><span>5</span> Exemples</a><div class="menu"><a class="item" href="#sec:solution"><div class="ui label">5.1</div> Solution</a></div></div><!-- FIX TOC -->
</div>

<div class="pusher" id="main-content">
    <div class="ui inverted top menu" id="top-menu">
        <div class="ui container">
	  <a class="launch icon item" id="sidebar-menu-button">
	    <i class="angle double left icon"></i>
	  </a>
	  <div class="item">
          Dungeons&amp;Diagrams
	  </div>
        </div>
      </div>
      <div class="ui padded basic segment shrink" id="main">
          <!-- <div class="masthead"> -->
<div class="segment">
<div class="ui container text">
<p><div class="ui image fluid">   <div class="ui inverted active dimmer">   <div class="content">     <h1 class="ui header" style="color:black; font-size: 4rem" >     Dungeons&Diagrams     </h1>   </div>   </div>   <img class="" src="assets/pics/chap_dand.png"> </div></p>
<p>Pour r√©soudre ce probl√®me, on partira du fichier <a
href="assets/data/d_and_d.c">d_and_d.c</a>.</p>
<h1 data-number="1"
id="sec:pr√©sentation-du-probl√®me-et-de-la-r√©solution"><span
class="header-section-number">1</span> Pr√©sentation du probl√®me et de la
r√©solution</h1>
<h2 data-number="1.1" id="sec:dd"><span
class="header-section-number">1.1</span> D&amp;D</h2>
<p><strong>Dungeons&amp;Diagrams</strong> (D&amp;D ) est un casse-t√™te
type <em>Sudoku</em> invent√© par Zach Barth et pr√©sent√© initialement sur
son site en <a
href="https://trashworldnews.com/files/advanced_dungeons_and_diagrams.pdf">version
papier</a> et, plus r√©cemment, au sein du jeu <em>Last Call BBS</em> de
<em>Zachtronics</em>.</p>
<p>Une grille de D&amp;D est la donn√©e d‚Äôune grille rectangulaire sur
laquelle figure des monstres üëπ et des tr√©sors üí∞, ainsi que des
indications chiffr√©es sur les colonnes et les lignes. Le but est de
remplir certaines cases vides par des murs en respectant les r√®gles
suivantes :</p>
<ul>
<li>Le nombre de murs sur une ligne (resp. une colonne) correspond au
nombre associ√© √† cette ligne (resp. cette colonne)</li>
<li>Tous les monstres sont dans des impasses et toutes les impasses
contiennent des monstres. Une impasse √©tant une case ayant exactement
une case voisine libre.</li>
<li>Chaque tr√©sor est dans une <em>salle au tr√©sor</em> qui est un carr√©
sans mur de taile 3x3 ne contenant aucun monstre et un seul tr√©sor et
qui, de plus, est bord√© de murs sauf en exactement une case qui doit
√™tre libre.</li>
<li>Le graphe induit par la grille avec des connexions directes, mais
pas en diagonale, est connexe.</li>
</ul>
<p>On suppose que les grilles admettent une unique solution.</p>
<p>Ainsi, par exemple, une grille 6x6 et son unique solution</p>
<p><center><div class="ui image center"><img
src="assets/pics/problem_ex.png" /> <img
src="assets/pics/problem_ex_sol.png" /></div></center></p>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>R√©soudre manuellement les 9 probl√®mes du PDF donn√© en lien
au-dessus.</p>
</div>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>Que peut-on dire du graphe d‚Äôune solution pour un probl√®me sans
tr√©sor ?</p>
</div>
<p>Si on consid√®re une grille satisfaisant les contraintes de lignes et
de colonnes, une fois une salle au tr√©sor identifi√©e, il est possible de
la remplir et de placer un monstre √† son unique entr√©e.</p>
<p><center><div class="ui image center"><img
src="assets/pics/problem_ex_sol.png" /> <span
class="math inline">\(\Rightarrow\)</span> <img
src="assets/pics/problem_ex_sol_fill.png" /></div></center></p>
<p>On en d√©duit ainsi une m√©thode de v√©rification des solutions :</p>
<ul>
<li>tester qu‚Äôil y a le bon nombre de murs dans chaque ligne et chaque
colonne</li>
<li>v√©rifier que chaque tr√©sor est dans une salle au tr√©sor
conforme</li>
<li>remplir les salles au tr√©sor et placer un monstre √† leur entr√©e</li>
<li>v√©rifier que le graphe est un arbre dont les feuilles sont les cases
contenant des monstres.</li>
</ul>
<p>En pratique, n‚Äôest pas n√©cessaire de v√©rifier la derni√®re condition
avec un parcours de graphe, on peut se contenter de v√©rifier que graphe
est localement arborescent :</p>
<ul>
<li>chaque case avec un monstre est de degr√© 1</li>
<li>chaque case libre est de degr√© au moins 2</li>
<li>il n‚Äôexiste pas de carr√© de cases libres</li>
</ul>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>Pourquoi cette v√©rification n‚Äôest pas suffisante <em>a priori</em>
?</p>
<p><strong>Bonus</strong> trouver une grille pour laquelle cette
approximation ne permet pas d‚Äôobtenir la solution.</p>
</div>
<p>Compte tenu de la v√©rification de la pr√©sence d‚Äôune unique entr√©e
dans une salle au tr√©sor, on peut r√©ordonner les v√©rifications :</p>
<ul>
<li>tester qu‚Äôil y a le bon nombre de murs dans chaque ligne et chaque
colonne</li>
<li>v√©rifier que les cases contenant des monstres sont de degr√© 1</li>
<li>v√©rifier que les cases libres sont de degr√© au moins 2</li>
<li>v√©rifier que chaque tr√©sor est dans une salle au tr√©sor
conforme</li>
<li>remplir les salles au tr√©sor</li>
<li>v√©rifier que la grille r√©sultante ne contient pas de carr√© de cases
libres</li>
</ul>
<h2 data-number="1.2"
id="sec:repr√©sentation-des-plateaux-en-64bit"><span
class="header-section-number">1.2</span> Repr√©sentation des plateaux en
64bit</h2>
<p>On va r√©soudre ce casse-t√™te par <em>backtracking</em> en C. Les
grilles √©tant de taille 8x8, on peut ainsi repr√©senter une information
bool√©enne sur chaque case √† l‚Äôaide d‚Äôentiers non sign√©s sur 64bit :
chaque bit est associ√© √† une case.</p>
<p>On choisit ici l‚Äôordre suivant :</p>
<p><center><div class="ui image center"><img
src="assets/pics/grille_ordre.png" /></div></center></p>
<p>qui correspond au mot binaire <span class="math inline">\(a_{63} ...
a_0\)</span> sur 64bits avec <span class="math inline">\(a_i\)</span>
repr√©sentant l‚Äôinformation sur la case <span
class="math inline">\(i\)</span>.</p>
<p>On va associer trois entiers √† une grille :</p>
<ul>
<li>le plateau (<em>board</em>) o√π un bool√©en vrai indique la pr√©sence
d‚Äôun mur</li>
<li>les monstres o√π un bool√©en vrai indique la pr√©sence d‚Äôun
monstre</li>
<li>les tr√©sors o√π un bool√©en vrai indique la pr√©sence d‚Äôun tr√©sor</li>
</ul>
<p>Par exemple, pour la grille :</p>
<p><center><div class="ui image center"><img
src="assets/pics/problem_0_.png" /></div></center></p>
<p>on a les monstres dans les positions 15, 18, 31, 47 et 63. Cela
correspond alors √† l‚Äôentier s‚Äô√©crivant en binaire <span
class="math display">\[
1000000000000000100000000000000010000000000001001000000000000000
\]</span> et qui vaut 9223512776490909696 en d√©cimal ainsi que
<code>0x8000800080048000</code> en hexad√©cimal.</p>
<p>On pourra √©crire en C :</p>
<p><div class="ui segment code"></p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">// au d√©but du fichier</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">typedef</span> <span class="dt">uint64_t</span> board<span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">// puis</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>board monsters <span class="op">=</span> <span class="bn">0x8000800080048000</span><span class="op">;</span></span></code></pre></div>
<p></div></p>
<p>On pourrait consid√©rer une repr√©sentation <em>developp√©e</em> sous la
forme d‚Äôun tableau de 64 bool√©ens. Dans ce cas-l√†, on obtiendrait la
valeur suivante en C :</p>
<p><div class="ui segment code"></p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">// au d√©but du fichier</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">typedef</span> <span class="dt">bool</span> map<span class="op">[</span><span class="dv">64</span><span class="op">];</span></span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">// puis</span></span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a>map monsters <span class="op">=</span> <span class="op">{</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="op">};</span></span></code></pre></div>
<p></div></p>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>√âcrire une fonction de signature <div class="ui segment code"></p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1"></a>board map_to_board<span class="op">(</span>map m<span class="op">);</span></span></code></pre></div>
<p></div> qui renvoie la repr√©sentation enti√®re associ√©e √† un
tableau.</p>
</div>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>√âcrire une fonction de signature <div class="ui segment code"></p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1"></a><span class="dt">void</span> board_to_map<span class="op">(</span>board b<span class="op">,</span> map m<span class="op">);</span></span></code></pre></div>
<p></div> qui prend en entr√©e une repr√©sentation enti√®re <code>b</code>,
un tableau <code>m</code> de 64 cases et place dans <code>m</code> le
tableau de bool√©ens d√©duit de <code>b</code>.</p>
</div>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>Faire des tests pour v√©rifier que ces deux fonctions sont correctes.
Notamment, qu‚Äôelles sont r√©ciproques l‚Äôune de l‚Äôautre.</p>
</div>
<h2 data-number="1.3" id="sec:repr√©sentation-du-probl√®me"><span
class="header-section-number">1.3</span> Repr√©sentation du probl√®me</h2>
<p>Pour repr√©senter le probl√®me, on utilise le type suivant en C :</p>
<p><div class="ui segment code"></p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">typedef</span> <span class="dt">char</span> constraint<span class="op">[</span><span class="dv">8</span><span class="op">];</span></span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw">struct</span> problem <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>    board monsters<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>    board treasures<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>    constraint rows<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>    constraint columns<span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="op">};</span></span>
<span id="cb5-9"><a href="#cb5-9"></a></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="kw">typedef</span> <span class="kw">struct</span> problem problem<span class="op">;</span></span></code></pre></div>
<p></div></p>
<p>Pour d√©finir un probl√®me, on peut le faire directement comme ici
:</p>
<p><div class="ui segment code"></p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1"></a>problem p <span class="op">=</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>    <span class="bn">0x8000800080048000</span><span class="op">,</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>    <span class="bn">0x20000000000</span><span class="op">,</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>    <span class="op">{</span> <span class="dv">3</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">4</span> <span class="op">},</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>    <span class="op">{</span> <span class="dv">1</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">4</span> <span class="op">}</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="op">};</span></span></code></pre></div>
<p></div></p>
<p>Mais par lisibilit√©, on peut pr√©ciser les noms des champs comme ici
:</p>
<p><div class="ui segment code"></p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1"></a>problem p <span class="op">=</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>    <span class="op">.</span>monsters <span class="op">=</span> <span class="bn">0x8000800080048000</span><span class="op">,</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="op">.</span>treasures <span class="op">=</span> <span class="bn">0x20000000000</span><span class="op">,</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>    <span class="op">.</span>rows <span class="op">=</span> <span class="op">{</span> <span class="dv">3</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">4</span> <span class="op">},</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>    <span class="op">.</span>columns <span class="op">=</span> <span class="op">{</span> <span class="dv">1</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">4</span> <span class="op">}</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="op">};</span></span></code></pre></div>
<p></div></p>
<p>Cette derni√®re syntaxe a l‚Äôavantage d‚Äôinitialiser √† 0 tous les champs
omis. On peut ainsi utiliser les fonctions pr√©c√©demment d√©finies pour
pr√©senter le probl√®me de mani√®re plus lisible dans le code source :</p>
<p><div class="ui segment code"></p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1"></a>problem p <span class="op">=</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>    <span class="op">.</span>rows <span class="op">=</span> <span class="op">{</span> <span class="dv">3</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">4</span> <span class="op">},</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>    <span class="op">.</span>columns <span class="op">=</span> <span class="op">{</span> <span class="dv">1</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">4</span> <span class="op">}</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="op">};</span></span>
<span id="cb8-5"><a href="#cb8-5"></a></span>
<span id="cb8-6"><a href="#cb8-6"></a>map monsters <span class="op">=</span> <span class="op">{</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb8-9"><a href="#cb8-9"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb8-13"><a href="#cb8-13"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-14"><a href="#cb8-14"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="op">};</span></span>
<span id="cb8-16"><a href="#cb8-16"></a></span>
<span id="cb8-17"><a href="#cb8-17"></a>map treasures <span class="op">=</span> <span class="op">{</span> </span>
<span id="cb8-18"><a href="#cb8-18"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-19"><a href="#cb8-19"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-20"><a href="#cb8-20"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-21"><a href="#cb8-21"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-25"><a href="#cb8-25"></a>    <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-26"><a href="#cb8-26"></a><span class="op">};</span></span>
<span id="cb8-27"><a href="#cb8-27"></a><span class="co">// ou plus rapidement</span></span>
<span id="cb8-28"><a href="#cb8-28"></a>map treasure <span class="op">=</span> <span class="op">{</span> <span class="op">[</span><span class="dv">41</span><span class="op">]</span> <span class="op">=</span> <span class="dv">1</span> <span class="op">};</span> <span class="co">// met 1 √† l&#39;indice 41 et 0 ailleurs</span></span>
<span id="cb8-29"><a href="#cb8-29"></a></span>
<span id="cb8-30"><a href="#cb8-30"></a>p<span class="op">.</span>monsters <span class="op">=</span> map_to_board<span class="op">(</span>monsters<span class="op">);</span></span>
<span id="cb8-31"><a href="#cb8-31"></a>p<span class="op">.</span>treasures <span class="op">=</span> map_to_board<span class="op">(</span>treasures<span class="op">);</span></span></code></pre></div>
<p></div></p>
<h2 data-number="1.4" id="sec:choix-pour-le-backtracking"><span
class="header-section-number">1.4</span> Choix pour le backtracking</h2>
<p>On va effectuer des remplissages incr√©mentaux de la grille pour
r√©soudre ce probl√®me par backtracking. On reprend donc la terminologie
de plateau et de coups permettant de passer d‚Äôun plateau √† un autre.</p>
<p>Une majeure partie des conditions de r√©solution portant sur des
grilles compl√®tes, on pourrait se contenter de v√©rifier uniquement les
grilles remplies. En faisant cela, on obtient un arbre d√©raisonnablement
grand.</p>
<p>Par exemple, avec comme coup le fait, pour une position donn√©e, de
choisir ou pas de placer un mur, on obtient un arbre binaire ayant <span
class="math inline">\(2^{64}\)</span> feuilles.</p>
<p>On va plut√¥t consid√©rer les coups consistants √† placer directement
<span class="math inline">\(k\)</span> murs sur une ligne dont on sait
qu‚Äôelle doit en contenir <span class="math inline">\(k\)</span>.</p>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>Justifier que si les indications de contraintes sur les lignes sont
donn√©es par les nombres <span class="math inline">\(l_1, \dots,
l_8\)</span> alors on obtient ainsi un arbre de backtracking ayant <span
class="math display">\[
\prod_{k=1}^8 \binom{8}{l_k}
\]</span> feuilles.</p>
<p>Dans le cas o√π <span class="math inline">\(l_1 = \dots = l_8 =
4\)</span>, comparer ce nombre avec le nombre obtenu en effectuant des
mouvements case par case.</p>
</div>
<p>M√™me si ce nombre est beaucoup plus petit que le pr√©c√©dent, cela
reste prohibitif pour faire une recherche exhaustive.</p>
<p>On va donc adopter une d√©tection des n≈ìuds pour lesquels on s‚Äôav√®re
certain de ne pas pouvoir r√©soudre le probl√®me.</p>
<p>Tout d‚Äôabord, on restreint les lignes √† celles qui ne placent pas un
mur sur la m√™me case qu‚Äôun monstre ou un tr√©sor.</p>
<p>Ensuite, si on un n≈ìud correspondant √† avoir rempli les k premi√®res
lignes, on v√©rifie :</p>
<ul>
<li>que le nombre de murs dans une colonne n‚Äôest pas strictement
sup√©rieur √† la contrainte (<strong>column overload</strong>)</li>
<li>qu‚Äôaucun monstre n‚Äôest sur une case de degr√© 0 (<strong>trapped
monsters</strong>)</li>
<li>qu‚Äôaucune case libre sur les k premi√®res lignes n‚Äôest de degr√© <span
class="math inline">\(\le 1\)</span> (<strong>no deadend upto
row</strong>)</li>
</ul>
<p>On a indiqu√© entre parenth√®ses les noms des fonctions qu‚Äôon
programmera dans la suite pour r√©aliser ces tests.</p>
<h1 data-number="2" id="sec:op√©rations-bit-√†-bit-en-c"><span
class="header-section-number">2</span> Op√©rations bit √† bit en C</h1>
<p>Dans ce paragraphe, on notera <code>0b10101</code> une valeur en
binaire en <code>C</code>. Cette notation, calqu√©e sur la notation
hexad√©cimale, n‚Äôest pas valide, mais rendra les exemples plus lisibles.
De m√™me, dans les formules, on notera <span
class="math inline">\({10101}_2\)</span> un nombre √©crit en binaire.</p>
<p>On va √©tudier ici des op√©rateurs op√©rant directement sur l‚Äô√©criture
binaire des entiers. Aucun de ces op√©rateurs n‚Äôest explicitement au
programme, cependant, leur usage permet, selon les contextes, d‚Äôavoir
code plus efficace et plus lisible.</p>
<h2 data-number="2.1" id="sec:op√©rateurs-de-d√©calage"><span
class="header-section-number">2.1</span> Op√©rateurs de d√©calage</h2>
<p>On utilise l‚Äôop√©ration <code>x &gt;&gt; k</code> pour d√©caler
l‚Äô√©criture de <code>x</code> de k bits vers la droite, cela revient donc
√† r√©aliser une division par <span
class="math inline">\(2^k\)</span>.</p>
<p>De m√™me, on utilise l‚Äôop√©ration <code>x &lt;&lt; k</code> pour
d√©caler son √©criture de k bits vers la gauche <em>en rajoutant des
0</em>.</p>
<p>Exemple :</p>
<ul>
<li><code>123 &gt;&gt; 3</code> vaut 15 car <code>123=0b1111011</code>
donc <code>123 &gt;&gt; 3 = 0b1111 = 15</code></li>
<li><code>123 &lt;&lt; 2</code> vaut 492 car
<code>123 &lt;&lt; 2 = 0b111101100 = 492</code></li>
</ul>
<p>Pour calculer <span class="math inline">\(2^k\)</span> on peut ainsi
√©crire <code>1 &lt;&lt; k</code> mais cela pose un probl√®me pour <span
class="math inline">\(k \ge 32\)</span> parce qeu <span
class="math inline">\(1\)</span> est un <code>int</code> et le calcul
fait apparaitre un d√©passement de capacit√© qui induit une troncature √†
0. Pour <span class="math inline">\(k \le 63\)</span>, on peut r√©gler ce
probl√®me en utilisant <code>1UL &lt;&lt; k</code> car <code>1UL</code>
est la constante <code>1</code> en <code>unsigned long</code>.</p>
<p>Cependant, comme ce probl√®me n‚Äôest pas propre aux constantes, on
pr√©f√®rera utiliser une coercition comme ici :
<code>(uint64_t)x &lt;&lt; k</code> qui fonctionne quand <code>x</code>
est un int.</p>
<p>On donne dans le code fourni une fonction
<div class="ui segment code"></p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1"></a><span class="dt">uint64_t</span> bit<span class="op">(</span><span class="dt">int</span> pos<span class="op">)</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>    <span class="cf">return</span> <span class="op">(</span><span class="dt">uint64_t</span><span class="op">)</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> pos<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="op">}</span></span></code></pre></div>
<p></div> afin de pouvoir √©crire directement <code>bit(n)</code> pour
calculer <span class="math inline">\(2^n\)</span> avec <span
class="math inline">\(n \in \range{0}{63}\)</span>.</p>
<h2 data-number="2.2" id="sec:op√©rateurs-logiques"><span
class="header-section-number">2.2</span> Op√©rateurs logiques</h2>
<p>Il est possible de r√©aliser les op√©rations logiques connues sur les
bool√©ens en les appliquant <em>bit √† bit</em>. Pour cela, on utilise
:</p>
<ul>
<li><code>a &amp; b</code> pour r√©aliser un <em>et</em> logique entre
chaque bit. Ainsi, en √©crivant abusivement en binaire, on a
<code>0b10110 &amp; 0b11010</code> qui vaut <code>0b10010</code>.</li>
<li><code>a | b</code> pour r√©aliser un <em>ou</em> logique entre chaque
bit. Ainsi, on a <code>0b10110 | 0b11010</code> qui vaut
<code>0b11110</code>.</li>
<li><code>a ^ b</code> pour r√©aliser un <em>ou exclusif</em> logique
entre chaque bit. Ainsi, on a <code>0b10110 ^ 0b11010</code> qui vaut
<code>0b01100</code>.</li>
<li><code>~a</code> pour r√©aliser la <em>n√©gation</em> logique de chaque
bit. Ainsi, on a <code>~0b10101</code> qui vaut
<code>0b01010</code>.</li>
</ul>
<p>Une mani√®re classique d‚Äôutiliser <code>&amp;</code> est de r√©aliser
des masquages : on stocke dans une variable <code>mask</code> les bits
que l‚Äôon veut √©tudier et on √©crit <code>x &amp; mask</code> pour ne
conserver que ceux-ci.`</p>
<p>L‚Äôop√©ration <code>|</code> permet de r√©aliser efficacement une
addition d‚Äôentiers dont les bits sont disjoints. En effet, comme il n‚Äôy
a pas de retenue dans ce cas-l√†, il suffit de superposer les √©critures
avec un <em>ou</em>.</p>
<p><div class="ui message orange"><div class="header">Remarque</div></p>
<p>Ces op√©rations utilisent de simples portes logiques et sont tr√®s
rapides √† ex√©cuter sur un processeur.</p>
<p>Notons que le compilateur les privil√©gie souvent. Par exemple, pour
tester la parit√© <code>x % 2 == 0</code> sera traduit par un test de
non-nullit√© de <code>x &amp; 1</code> et les divisions/multiplications
par <span class="math inline">\(2^k\)</span> sont remplac√©es par des
d√©calages.</p>
<p></div></p>
<h2 data-number="2.3" id="sec:popcount"><span
class="header-section-number">2.3</span> Popcount</h2>
<p>On va avoir besoin de compter les murs ou les cases libres, pour cela
on utilise une op√©ration appel√©e <code>popcount</code> (pour
<em>population count</em>) qui permet, √©tant donn√© un entier non sign√©
<code>x</code> sur 64bits de renvoyer le nombre <span
class="math inline">\(p(x) \in \range{0}{64}\)</span> de 1 dans son
√©criture binaire.</p>
<p>Dans la suite, on utilisera cette fonction sur un plateau pour
compter les murs ou sur sa n√©gation pour compter les cases libres.</p>
<h3 data-number="2.3.1" id="sec:calcul-na√Øf"><span
class="header-section-number">2.3.1</span> Calcul na√Øf</h3>
<p>Pour r√©aliser un calcul na√Øf, on va juste it√©rer sur les bits en
faisant des tests de parit√© et des division par 2.</p>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>√âcrire une fonction de signature <div class="ui segment code"></p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1"></a><span class="dt">int</span> popcount_slow<span class="op">(</span><span class="dt">uint64_t</span> x<span class="op">);</span></span></code></pre></div>
<p></div> qui effectue ce calcul.</p>
</div>
<p>On pourrait penser que ce code est long en raison de la boucle, mais
en fait, celle-ci sera s√ªrement d√©roul√©e par le compilateur et le
probl√®me vient des branchements induits par les tests de parit√©.</p>
<h3 data-number="2.3.2" id="sec:calcul-par-masquage-et-additions"><span
class="header-section-number">2.3.2</span> Calcul par masquage et
additions</h3>
<p>Soit <span class="math inline">\(p &gt; 0\)</span> et <span
class="math inline">\(x,y\)</span> deux entiers tels que <span
class="math inline">\(x, y \le p &lt; 2^p\)</span>. On a alors <span
class="math inline">\(x + y \le 2p &lt; 2^{p+1}\)</span> ainsi, si <span
class="math inline">\(z = x 2^p + y\)</span> en consid√©rant le masque
<span class="math inline">\(m = 2^p - 1\)</span> on peut calculer <span
class="math inline">\(x+y\)</span> ainsi :
<div class="ui segment code"></p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1"></a><span class="op">(</span>z <span class="op">&amp;</span> m<span class="op">)</span> <span class="op">+</span> <span class="op">((</span>z <span class="op">&amp;</span> <span class="op">(</span>m <span class="op">&lt;&lt;</span> p<span class="op">))</span> <span class="op">&gt;&gt;</span> p<span class="op">)</span></span></code></pre></div>
<p></div></p>
<p>Cette remarque a priori anodine permet de r√©aliser un calcul efficace
de <code>popcount</code>. En effet, on souhaite effectuer en place la
somme de tous les bits d‚Äôun entier.</p>
<p>Si <code>x</code> est un entier sur 8 bits, on peut se servir du
proc√©d√© de masquage pour r√©aliser plusieurs additions d‚Äôun coup √† l‚Äôaide
des masques <span class="math display">\[
m_1 = \overline{01010101}^2
\quad
m_2 = \overline{00110011}^2
\quad
m_3 = \overline{00001111}^2
\]</span></p>
<p>Par exemple, si <span class="math inline">\(x = 173 =
\overline{10101101}^2\)</span>, on va avoir :</p>
<p><span class="math display">\[
\begin{array}{ccc||c|c|c}
z &amp; m &amp; p &amp; z \&amp; m &amp; (z \&amp; (m &lt;&lt; p))
&gt;&gt; p
&amp;  z \&amp; m + (z \&amp; (m &lt;&lt; p)) &gt;&gt; p \\
10101101 &amp; 01010101 &amp; 1 &amp;
{\color{red}00}{\color{green}00}{\color{blue}01}01
&amp; {\color{red}01}{\color{green}01}{\color{blue}01}00
&amp; {\color{red}01}{\color{green}01}{\color{blue}10}01 \\
01011001 &amp; 00110011 &amp; 2 &amp; {\color{red}0001}0001
&amp; {\color{red}0001}0010 &amp; {\color{red}0010}0011 \\
00100011 &amp; 00001111 &amp; 4 &amp; 00000011 &amp; 00000010 &amp;
00000101
\end{array}
\]</span></p>
<p>Ici, les couleurs servent √† identifier les sous-mots sur lesquels
portent les additions.</p>
<p>Le dernier r√©sultat est alors le nombre de 1 pr√©sent dans <span
class="math inline">\(x\)</span> : <span
class="math inline">\(\overline{00000101}^2 = 5\)</span>.</p>
<p>On en d√©duit le programme C suivant :</p>
<p><div class="ui segment code"></p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1"></a><span class="dt">unsigned</span> <span class="dt">char</span> popcount_byte<span class="op">(</span><span class="dt">unsigned</span> <span class="dt">char</span> x<span class="op">)</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>    <span class="dt">unsigned</span> <span class="dt">char</span> m1 <span class="op">=</span> <span class="bn">0x55</span><span class="op">;</span> <span class="co">// 0b01010101</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>    <span class="dt">unsigned</span> <span class="dt">char</span> m2 <span class="op">=</span> <span class="bn">0x33</span><span class="op">;</span> <span class="co">// 0b00110011</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>    <span class="dt">unsigned</span> <span class="dt">char</span> m3 <span class="op">=</span> <span class="bn">0x0f</span><span class="op">;</span> <span class="co">// 0b00001111</span></span>
<span id="cb12-6"><a href="#cb12-6"></a></span>
<span id="cb12-7"><a href="#cb12-7"></a>    x <span class="op">=</span> <span class="op">(</span>x<span class="op">&amp;</span>m1<span class="op">)</span> <span class="op">+</span> <span class="op">((</span>x<span class="op">&amp;(</span>m1<span class="op">&lt;&lt;</span><span class="dv">1</span><span class="op">))&gt;&gt;</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>    x <span class="op">=</span> <span class="op">(</span>x<span class="op">&amp;</span>m2<span class="op">)</span> <span class="op">+</span> <span class="op">((</span>x<span class="op">&amp;(</span>m2<span class="op">&lt;&lt;</span><span class="dv">2</span><span class="op">))&gt;&gt;</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb12-9"><a href="#cb12-9"></a>    x <span class="op">=</span> <span class="op">(</span>x<span class="op">&amp;</span>m3<span class="op">)</span> <span class="op">+</span> <span class="op">((</span>x<span class="op">&amp;(</span>m3<span class="op">&lt;&lt;</span><span class="dv">4</span><span class="op">))&gt;&gt;</span><span class="dv">4</span><span class="op">);</span></span>
<span id="cb12-10"><a href="#cb12-10"></a></span>
<span id="cb12-11"><a href="#cb12-11"></a>    <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb12-12"><a href="#cb12-12"></a><span class="op">}</span></span></code></pre></div>
<p></div></p>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>En d√©duire une fonction de signature
<div class="ui segment code"></p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1"></a><span class="dt">int</span> popcount<span class="op">(</span><span class="dt">uint64_t</span> x<span class="op">);</span></span></code></pre></div>
<p></div> qui calcule le popcount d‚Äôun entier sur 64bits en utilisant
cette m√©thode. On peut se contenter de renvoyer un int car on sait que
la valeur renvoy√©e est dans <span
class="math inline">\(\range{0}{64}\)</span>.</p>
</div>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>Combien cette fonction fait-elle d‚Äôop√©rations √©l√©mentaires ?</p>
</div>
<h3 data-number="2.3.3" id="sec:instruction-assembleur"><span
class="header-section-number">2.3.3</span> Instruction assembleur</h3>
<p>Il existe une fonction <code>__builtin_popcountll</code> permettant
de r√©aliser un popcount gr√¢ce √† une instruction assembleur quand elle
est disponible sur l‚Äôarchitecture vis√©e, ou avec le code qu‚Äôon vient de
voir quand ce n‚Äôest pas le cas.</p>
<p>Si votre processeur dispose de cette instruction, vous pouvez
compiler avec le flag <code>-mpopcnt</code> pour l‚Äôutiliser. Cela
permettra d‚Äôam√©liorer les performances.</p>
<h1 data-number="3" id="sec:squelette-du-backtracking"><span
class="header-section-number">3</span> Squelette du backtracking</h1>
<p>La fonction r√©cursive <code>solve</code> r√©alisant le backtracking a
la structure suivante :</p>
<p><div class="ui segment code"></p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1"></a><span class="dt">void</span> solve<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> <span class="dt">int</span> row<span class="op">,</span> board b<span class="op">)</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="op">{</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>    <span class="co">// teste si b est une impasse et sort</span></span>
<span id="cb14-4"><a href="#cb14-4"></a></span>
<span id="cb14-5"><a href="#cb14-5"></a>    <span class="co">// b est une feuille de l&#39;arbre</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>    <span class="cf">if</span><span class="op">(</span>row <span class="op">==</span> <span class="dv">8</span><span class="op">)</span></span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="op">{</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>        <span class="co">// teste et sort si ce n&#39;est pas une solution</span></span>
<span id="cb14-9"><a href="#cb14-9"></a></span>
<span id="cb14-10"><a href="#cb14-10"></a>        printf<span class="op">(</span><span class="st">&quot;Solution %lx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> b<span class="op">);</span> </span>
<span id="cb14-11"><a href="#cb14-11"></a>        print_board<span class="op">(</span>p<span class="op">,</span> b<span class="op">);</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb14-13"><a href="#cb14-13"></a>    <span class="op">}</span></span>
<span id="cb14-14"><a href="#cb14-14"></a></span>
<span id="cb14-15"><a href="#cb14-15"></a>    <span class="co">// pour chaque mouvement move valide dans</span></span>
<span id="cb14-16"><a href="#cb14-16"></a>    <span class="co">// la rang√©e row </span></span>
<span id="cb14-17"><a href="#cb14-17"></a>        solve<span class="op">(</span>p<span class="op">,</span> row<span class="op">+</span><span class="dv">1</span><span class="op">,</span> b<span class="op">+</span>move<span class="op">);</span></span>
<span id="cb14-18"><a href="#cb14-18"></a><span class="op">}</span></span></code></pre></div>
<p></div></p>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>√âcrire une fonction de signature <div class="ui segment code"></p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1"></a><span class="dt">void</span> print_board<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">);</span></span></code></pre></div>
<p></div> qui permet d‚Äôafficher le plateau avec un affichage comme
celui-ci :</p>
<pre><code>###...##
#...#...
M.#.#...
#...#T..
###.####
.....#.M
M#M#.#.#
####...#</code></pre>
<p>o√π <code>#</code> est un mur, <code>M</code> est un monstre,
<code>T</code> un tr√©sor et <code>.</code> est une case libre.</p>
</div>
<p>Afin de r√©aliser la boucle sur les mouvements, on peut it√©rer sur les
256 placements possibles de murs, ne garder que ceux qui ont le bon
nombre de murs et qui ne se superposent pas aux monstres et aux
tr√©sors.</p>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>√âcrire le test permettant de s‚Äôassurer que <code>move</code> n‚Äôest
pas en conflit avec les monstres et les tr√©sors du probl√®me
<code>p</code>.</p>
</div>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>√âcrire la boucle en utilisant <code>popcount</code> pour tester qu‚Äôil
y a le bon nombre de murs.</p>
</div>
<p>La fonction pr√©c√©dente va refaire continuellement les m√™mes calculs
de <code>popcount</code>.</p>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>Dans le programme donn√©, il y a une variable globale
<div class="ui segment code"></p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1"></a><span class="dt">int</span> enum_popcount_byte<span class="op">[</span><span class="dv">256</span><span class="op">];</span></span></code></pre></div>
<p></div> Rajouter les instructions dans <code>main</code> pour que
<code>enum_popcount_byte[i]</code> contienne la valeur
<code>popcount(i)</code> et en d√©duire une version plus efficace de la
boucle pr√©c√©dente.</p>
</div>
<p><div class="ui message orange"><div class="header">Remarque</div></p>
<p>On peut r√©duire les branchements en pr√©calculant les tableaux de
placements pour chaque nombre de murs.</p>
<p></div></p>
<h1 data-number="4"
id="sec:impl√©mentation-des-diff√©rentes-v√©rifications"><span
class="header-section-number">4</span> Impl√©mentation des diff√©rentes
v√©rifications</h1>
<h2 data-number="4.1" id="sec:tests-pour-les-colonnes"><span
class="header-section-number">4.1</span> Tests pour les colonnes</h2>
<p>Il n‚Äôest pas n√©cessaire de tester si les lignes ont le bon nombre de
murs, car on a restreint le backtracking pour l‚Äôassurer.</p>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>D√©terminer un masque correspondant √† la premi√®re colonne.</p>
<p>En d√©duire, √† l‚Äôaide de d√©calages, une fonction de signature
<div class="ui segment code"></p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1"></a><span class="dt">uint64_t</span> mask_column<span class="op">(</span><span class="dt">int</span> i<span class="op">)</span></span></code></pre></div>
<p></div> renvoyant un masque correspondant √† la colonne
<code>i</code>.</p>
</div>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>En d√©duire des fonctions de signature
<div class="ui segment code"></p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1"></a><span class="dt">bool</span> test_columns_overload<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">);</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="dt">bool</span> test_columns_underload<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">);</span></span></code></pre></div>
<p></div> Testant respectivement si une colonne √† trop ou pas assez de
murs dans le plateau.</p>
</div>
<h2 data-number="4.2" id="sec:impasses"><span
class="header-section-number">4.2</span> Impasses</h2>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>√âcrire une fonction de signature <div class="ui segment code"></p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1"></a><span class="dt">bool</span> empty<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">,</span> <span class="dt">int</span> pos<span class="op">);</span></span></code></pre></div>
<p></div> indiquant s‚Äôil y a une case libre dans le plateau
<code>b</code> √† la position <code>pos</code>.</p>
<p>Attention, une case contenant un monstre ou un tr√©sor n‚Äôest pas
libre.</p>
</div>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>√âcrire des fonctions de signature <div class="ui segment code"></p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1"></a><span class="dt">bool</span> treasure<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> <span class="dt">int</span> pos<span class="op">);</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="dt">bool</span> monster<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> <span class="dt">int</span> pos<span class="op">);</span></span></code></pre></div>
<p></div> d√©terminant respectivement s‚Äôil y a un tr√©sor ou un monstre √†
la position <code>pos</code>.</p>
</div>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>√âcrire une fonction de signature <div class="ui segment code"></p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb22-1"><a href="#cb22-1"></a><span class="dt">uint64_t</span> neighbours<span class="op">(</span><span class="dt">int</span> pos<span class="op">);</span></span></code></pre></div>
<p></div> qui renvoie le masque correspondant aux cases voisines de la
position <code>pos</code>. Ce masque contiendra ainsi de <code>2</code>
√† <code>4</code> bits √† 1 selon les positions (<code>2</code> aux coins,
<code>3</code> sur les bords stricts et <code>4</code> √† l‚Äôint√©rieur du
plateau).</p>
</div>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>En d√©duire une fonction de signature
<div class="ui segment code"></p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb23-1"><a href="#cb23-1"></a><span class="dt">int</span> count_non_wall<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">,</span> <span class="dt">int</span> pos<span class="op">);</span></span></code></pre></div>
<p></div> qui compte le nombre de cases qui ne sont pas des murs dans le
voisinage de <code>pos</code>.</p>
<p><em>On pensera bien √† prendre en compte la n√©gation du plateau pour
ne pas avoir besoin de faire de cas selon qu‚Äôon soit √† l‚Äôint√©rieur ou
sur un bord.</em></p>
</div>
<p>Maintenant qu‚Äôon peut compter le degr√© d‚Äôune position dans le graphe,
on peut r√©aliser les tests pr√©sent√©s plus haut.</p>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>√âcrire une fonction de signature <div class="ui segment code"></p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb24-1"><a href="#cb24-1"></a><span class="dt">bool</span> test_deadends<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">);</span></span></code></pre></div>
<p></div> qui v√©rifie que dans le plateau <code>b</code> : * tous les
monstres sont des impasses * aucune case libre n‚Äôest dans une
impasse.</p>
</div>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>√âcrire une fonction de signature <div class="ui segment code"></p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb25-1"><a href="#cb25-1"></a><span class="dt">bool</span> test_no_deadend_upto_row<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">,</span> <span class="dt">int</span> row<span class="op">);</span></span></code></pre></div>
<p></div> qui v√©rifie qu‚Äôaucune case libre n‚Äôest dans une impasse dans
les rang√©es d‚Äôindice <code>&lt; row</code>.</p>
</div>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>√âcrire une fonction de signature <div class="ui segment code"></p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb26-1"><a href="#cb26-1"></a><span class="dt">bool</span> test_trapped_monster<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">);</span></span></code></pre></div>
<p></div> qui v√©rifie qu‚Äôaucun monstre n‚Äôest pi√©g√© par des murs.</p>
</div>
<h3 data-number="4.2.1" id="sec:carr√©s-libres"><span
class="header-section-number">4.2.1</span> Carr√©s libres</h3>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>D√©terminer un masque correspondant √† un carr√© de quatre cases
commen√ßant √† la position 0.</p>
</div>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>En d√©duire une fonction de signature
<div class="ui segment code"></p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb27-1"><a href="#cb27-1"></a><span class="dt">bool</span> test_empty_squares<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">);</span></span></code></pre></div>
<p></div> qui teste qu‚Äôil n‚Äôy a pas de carr√© de quatre cases libres dans
le plateau <code>b</code>.</p>
</div>
<p><div class="ui message orange"><div class="header">Remarque</div></p>
<p>√Ä partir d‚Äôici, vous pouvez r√©soudre tous les probl√®mes ne comportant
pas de tr√©sors.</p>
<p></div></p>
<h3 data-number="4.2.2" id="sec:salles-au-tr√©sor"><span
class="header-section-number">4.2.2</span> Salles au tr√©sor</h3>
<p>Pour chaque tr√©sor, on va appliquer la m√©thode suivante :</p>
<ul>
<li>√† l‚Äôaide d‚Äôun masque correspondant √† un carr√© 3x3, identifier une
possible salle au tr√©sor autour du tr√©sor (pas la peine de toute les
chercher, il ne peut il y en avoir qu‚Äôune)</li>
<li>√† l‚Äôaide d‚Äôun masque correspondant √† la bordure de la salle, en
prenant garde au fait qu‚Äôelle n‚Äôest pas n√©cessairement √† l‚Äôint√©rieur du
plateau, d√©terminer l‚Äôunique ouverture de la salle</li>
<li>remplir la salle au tr√©sor de mur</li>
</ul>
<p>Si jamais on n‚Äôarrive pas √† trouver une salle valide, on sait que le
plateau est insoluble.</p>
<div class="ui message blue">
<div class="header">
Question
</div>
<p>√âcrire une fonction de signature <div class="ui segment code"></p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb28-1"><a href="#cb28-1"></a><span class="dt">bool</span> test_treasure_rooms<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board <span class="op">*</span>b<span class="op">);</span></span></code></pre></div>
<p></div> qui teste si toutes les tr√©sors sont dans des salles valides
et les remplit par des murs √† l‚Äôaide du pointeur <code>b</code>.</p>
</div>
<p><div class="ui message orange"><div class="header">Remarque</div></p>
<p>Vous pouvez maintenant r√©soudre tous les probl√®mes. En tenant compte
de toutes les optimisations dans les remarques et en compilant en
<code>-O3</code>, il est possible de r√©soudre les 64 probl√®mes en moins
de 500ms !</p>
<p></div></p>
<h1 data-number="5" id="sec:exemples"><span
class="header-section-number">5</span> Exemples</h1>
<p>Les exemples de probl√®me pr√©sents dans le fichier d‚Äôen-t√™te sont
reproduits ici dans le m√™me ordre.</p>
<p><img src="assets/pics/problem_18.png" /> <img
src="assets/pics/problem_21.png" /> <img
src="assets/pics/problem_20.png" /></p>
<p><img src="assets/pics/problem_28.png" /> <img
src="assets/pics/problem_a.png" /> <img
src="assets/pics/problem_36.png" /></p>
<p><img src="assets/pics/problem_35.png" /> <img
src="assets/pics/problem_34.png" /> <img
src="assets/pics/problem_b.png" /></p>
<h2 data-number="5.1" id="sec:solution"><span
class="header-section-number">5.1</span> Solution</h2>
<p><div class="ui segment code"></p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="cb29-1"><a href="#cb29-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></span>
<span id="cb29-5"><a href="#cb29-5"></a></span>
<span id="cb29-6"><a href="#cb29-6"></a><span class="kw">typedef</span> <span class="dt">uint64_t</span> board<span class="op">;</span></span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="kw">typedef</span> <span class="dt">bool</span> map<span class="op">[</span><span class="dv">64</span><span class="op">];</span></span>
<span id="cb29-8"><a href="#cb29-8"></a><span class="kw">typedef</span> <span class="dt">char</span> constraint<span class="op">[</span><span class="dv">8</span><span class="op">];</span></span>
<span id="cb29-9"><a href="#cb29-9"></a></span>
<span id="cb29-10"><a href="#cb29-10"></a><span class="kw">struct</span> problem <span class="op">{</span></span>
<span id="cb29-11"><a href="#cb29-11"></a>    board monsters<span class="op">;</span></span>
<span id="cb29-12"><a href="#cb29-12"></a>    board treasures<span class="op">;</span></span>
<span id="cb29-13"><a href="#cb29-13"></a>    constraint rows<span class="op">;</span></span>
<span id="cb29-14"><a href="#cb29-14"></a>    constraint columns<span class="op">;</span></span>
<span id="cb29-15"><a href="#cb29-15"></a><span class="op">};</span></span>
<span id="cb29-16"><a href="#cb29-16"></a><span class="kw">typedef</span> <span class="kw">struct</span> problem problem<span class="op">;</span></span>
<span id="cb29-17"><a href="#cb29-17"></a></span>
<span id="cb29-18"><a href="#cb29-18"></a>problem p1 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb29-19"><a href="#cb29-19"></a>    <span class="op">.</span>monsters <span class="op">=</span> <span class="bn">0x8400010000000020</span><span class="op">,</span></span>
<span id="cb29-20"><a href="#cb29-20"></a>    <span class="op">.</span>treasures <span class="op">=</span> <span class="bn">0x20000</span><span class="op">,</span></span>
<span id="cb29-21"><a href="#cb29-21"></a>    <span class="op">.</span>rows <span class="op">=</span> <span class="op">{</span> <span class="dv">7</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">3</span> <span class="op">},</span></span>
<span id="cb29-22"><a href="#cb29-22"></a>    <span class="op">.</span>columns <span class="op">=</span> <span class="op">{</span> <span class="dv">4</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">7</span> <span class="op">}</span></span>
<span id="cb29-23"><a href="#cb29-23"></a><span class="op">};</span></span>
<span id="cb29-24"><a href="#cb29-24"></a></span>
<span id="cb29-25"><a href="#cb29-25"></a>problem p2 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb29-26"><a href="#cb29-26"></a>    <span class="op">.</span>monsters <span class="op">=</span> <span class="bn">0xa00008000000000</span><span class="op">,</span></span>
<span id="cb29-27"><a href="#cb29-27"></a>    <span class="op">.</span>treasures <span class="op">=</span> <span class="bn">0x2800</span><span class="op">,</span></span>
<span id="cb29-28"><a href="#cb29-28"></a>    <span class="op">.</span>rows <span class="op">=</span> <span class="op">{</span> <span class="dv">5</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">1</span> <span class="op">},</span></span>
<span id="cb29-29"><a href="#cb29-29"></a>    <span class="op">.</span>columns <span class="op">=</span> <span class="op">{</span> <span class="dv">5</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">1</span> <span class="op">}</span></span>
<span id="cb29-30"><a href="#cb29-30"></a><span class="op">};</span></span>
<span id="cb29-31"><a href="#cb29-31"></a></span>
<span id="cb29-32"><a href="#cb29-32"></a>problem p3 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb29-33"><a href="#cb29-33"></a>    <span class="op">.</span>monsters <span class="op">=</span> <span class="bn">0x8000008001000081</span><span class="op">,</span></span>
<span id="cb29-34"><a href="#cb29-34"></a>    <span class="op">.</span>treasures <span class="op">=</span> <span class="bn">0x4000000000000</span><span class="op">,</span></span>
<span id="cb29-35"><a href="#cb29-35"></a>    <span class="op">.</span>rows <span class="op">=</span> <span class="op">{</span> <span class="dv">6</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span> <span class="op">},</span></span>
<span id="cb29-36"><a href="#cb29-36"></a>    <span class="op">.</span>columns <span class="op">=</span> <span class="op">{</span> <span class="dv">4</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">1</span> <span class="op">}</span></span>
<span id="cb29-37"><a href="#cb29-37"></a><span class="op">};</span></span>
<span id="cb29-38"><a href="#cb29-38"></a></span>
<span id="cb29-39"><a href="#cb29-39"></a>problem p4 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb29-40"><a href="#cb29-40"></a>    <span class="op">.</span>monsters <span class="op">=</span> <span class="bn">0x8000800000000100</span><span class="op">,</span></span>
<span id="cb29-41"><a href="#cb29-41"></a>    <span class="op">.</span>treasures <span class="op">=</span> <span class="bn">0x2000</span><span class="op">,</span></span>
<span id="cb29-42"><a href="#cb29-42"></a>    <span class="op">.</span>rows <span class="op">=</span> <span class="op">{</span> <span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">0</span> <span class="op">},</span></span>
<span id="cb29-43"><a href="#cb29-43"></a>    <span class="op">.</span>columns <span class="op">=</span> <span class="op">{</span> <span class="dv">1</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">6</span> <span class="op">}</span></span>
<span id="cb29-44"><a href="#cb29-44"></a><span class="op">};</span></span>
<span id="cb29-45"><a href="#cb29-45"></a></span>
<span id="cb29-46"><a href="#cb29-46"></a>problem p5 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb29-47"><a href="#cb29-47"></a>    <span class="op">.</span>monsters <span class="op">=</span> <span class="bn">0x20001</span><span class="op">,</span></span>
<span id="cb29-48"><a href="#cb29-48"></a>    <span class="op">.</span>treasures <span class="op">=</span> <span class="bn">0x80000</span><span class="op">,</span></span>
<span id="cb29-49"><a href="#cb29-49"></a>    <span class="op">.</span>rows <span class="op">=</span> <span class="op">{</span> <span class="dv">0</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">5</span> <span class="op">},</span></span>
<span id="cb29-50"><a href="#cb29-50"></a>    <span class="op">.</span>columns <span class="op">=</span> <span class="op">{</span> <span class="dv">7</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">1</span> <span class="op">}</span></span>
<span id="cb29-51"><a href="#cb29-51"></a><span class="op">};</span></span>
<span id="cb29-52"><a href="#cb29-52"></a></span>
<span id="cb29-53"><a href="#cb29-53"></a>problem p6 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb29-54"><a href="#cb29-54"></a>    <span class="op">.</span>monsters <span class="op">=</span> <span class="bn">0x802080208020</span><span class="op">,</span></span>
<span id="cb29-55"><a href="#cb29-55"></a>    <span class="op">.</span>treasures <span class="op">=</span> <span class="bn">0x40000</span><span class="op">,</span></span>
<span id="cb29-56"><a href="#cb29-56"></a>    <span class="op">.</span>rows <span class="op">=</span> <span class="op">{</span> <span class="dv">6</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">3</span> <span class="op">},</span></span>
<span id="cb29-57"><a href="#cb29-57"></a>    <span class="op">.</span>columns <span class="op">=</span> <span class="op">{</span> <span class="dv">5</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">5</span> <span class="op">}</span></span>
<span id="cb29-58"><a href="#cb29-58"></a><span class="op">};</span></span>
<span id="cb29-59"><a href="#cb29-59"></a></span>
<span id="cb29-60"><a href="#cb29-60"></a>problem p7 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb29-61"><a href="#cb29-61"></a>    <span class="op">.</span>monsters <span class="op">=</span> <span class="bn">0x80010008</span><span class="op">,</span></span>
<span id="cb29-62"><a href="#cb29-62"></a>    <span class="op">.</span>treasures <span class="op">=</span> <span class="bn">0x80000000000000</span><span class="op">,</span></span>
<span id="cb29-63"><a href="#cb29-63"></a>    <span class="op">.</span>rows <span class="op">=</span> <span class="op">{</span> <span class="dv">1</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">1</span> <span class="op">},</span></span>
<span id="cb29-64"><a href="#cb29-64"></a>    <span class="op">.</span>columns <span class="op">=</span> <span class="op">{</span> <span class="dv">1</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">1</span> <span class="op">}</span></span>
<span id="cb29-65"><a href="#cb29-65"></a><span class="op">};</span></span>
<span id="cb29-66"><a href="#cb29-66"></a></span>
<span id="cb29-67"><a href="#cb29-67"></a>problem p8 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb29-68"><a href="#cb29-68"></a>    <span class="op">.</span>monsters <span class="op">=</span> <span class="bn">0x4200801000800042</span><span class="op">,</span></span>
<span id="cb29-69"><a href="#cb29-69"></a>    <span class="op">.</span>treasures <span class="op">=</span> <span class="bn">0x0</span><span class="op">,</span></span>
<span id="cb29-70"><a href="#cb29-70"></a>    <span class="op">.</span>rows <span class="op">=</span> <span class="op">{</span> <span class="dv">3</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">3</span> <span class="op">},</span></span>
<span id="cb29-71"><a href="#cb29-71"></a>    <span class="op">.</span>columns <span class="op">=</span> <span class="op">{</span> <span class="dv">4</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">6</span> <span class="op">}</span></span>
<span id="cb29-72"><a href="#cb29-72"></a><span class="op">};</span></span>
<span id="cb29-73"><a href="#cb29-73"></a></span>
<span id="cb29-74"><a href="#cb29-74"></a>problem p9 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb29-75"><a href="#cb29-75"></a>    <span class="op">.</span>monsters <span class="op">=</span> <span class="bn">0x40080</span><span class="op">,</span></span>
<span id="cb29-76"><a href="#cb29-76"></a>    <span class="op">.</span>treasures <span class="op">=</span> <span class="bn">0x200000000000000</span><span class="op">,</span></span>
<span id="cb29-77"><a href="#cb29-77"></a>    <span class="op">.</span>rows <span class="op">=</span> <span class="op">{</span> <span class="dv">4</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">2</span> <span class="op">},</span></span>
<span id="cb29-78"><a href="#cb29-78"></a>    <span class="op">.</span>columns <span class="op">=</span> <span class="op">{</span> <span class="dv">5</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span> <span class="op">}</span></span>
<span id="cb29-79"><a href="#cb29-79"></a><span class="op">};</span></span>
<span id="cb29-80"><a href="#cb29-80"></a></span>
<span id="cb29-81"><a href="#cb29-81"></a><span class="dt">uint64_t</span> mask_column<span class="op">(</span><span class="dt">int</span> i<span class="op">)</span></span>
<span id="cb29-82"><a href="#cb29-82"></a><span class="op">{</span></span>
<span id="cb29-83"><a href="#cb29-83"></a>    <span class="cf">return</span> <span class="bn">0x0101010101010101</span> <span class="op">&lt;&lt;</span> i<span class="op">;</span></span>
<span id="cb29-84"><a href="#cb29-84"></a><span class="op">}</span></span>
<span id="cb29-85"><a href="#cb29-85"></a></span>
<span id="cb29-86"><a href="#cb29-86"></a>board map_to_board<span class="op">(</span>map m<span class="op">)</span></span>
<span id="cb29-87"><a href="#cb29-87"></a><span class="op">{</span></span>
<span id="cb29-88"><a href="#cb29-88"></a>    board b <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb29-89"><a href="#cb29-89"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">64</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb29-90"><a href="#cb29-90"></a>    <span class="op">{</span> </span>
<span id="cb29-91"><a href="#cb29-91"></a>        b <span class="op">=</span> b <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb29-92"><a href="#cb29-92"></a>        <span class="cf">if</span> <span class="op">(</span>m<span class="op">[</span>i<span class="op">])</span></span>
<span id="cb29-93"><a href="#cb29-93"></a>            b <span class="op">=</span> b <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb29-94"><a href="#cb29-94"></a>    <span class="op">}</span></span>
<span id="cb29-95"><a href="#cb29-95"></a>    <span class="cf">return</span> b<span class="op">;</span></span>
<span id="cb29-96"><a href="#cb29-96"></a><span class="op">}</span></span>
<span id="cb29-97"><a href="#cb29-97"></a></span>
<span id="cb29-98"><a href="#cb29-98"></a><span class="dt">void</span> board_to_map<span class="op">(</span>board b<span class="op">,</span> map m<span class="op">)</span></span>
<span id="cb29-99"><a href="#cb29-99"></a><span class="op">{</span></span>
<span id="cb29-100"><a href="#cb29-100"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">64</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb29-101"><a href="#cb29-101"></a>    <span class="op">{</span></span>
<span id="cb29-102"><a href="#cb29-102"></a>        m<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> b <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb29-103"><a href="#cb29-103"></a>        b <span class="op">=</span> b <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb29-104"><a href="#cb29-104"></a>    <span class="op">}</span></span>
<span id="cb29-105"><a href="#cb29-105"></a><span class="op">}</span></span>
<span id="cb29-106"><a href="#cb29-106"></a></span>
<span id="cb29-107"><a href="#cb29-107"></a></span>
<span id="cb29-108"><a href="#cb29-108"></a><span class="dt">int</span> popcount_slow<span class="op">(</span><span class="dt">uint64_t</span> v<span class="op">)</span></span>
<span id="cb29-109"><a href="#cb29-109"></a><span class="op">{</span></span>
<span id="cb29-110"><a href="#cb29-110"></a>    <span class="dt">int</span> s <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb29-111"><a href="#cb29-111"></a>    <span class="cf">while</span><span class="op">(</span>v <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb29-112"><a href="#cb29-112"></a>    <span class="op">{</span></span>
<span id="cb29-113"><a href="#cb29-113"></a>        <span class="cf">if</span> <span class="op">(</span>v <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb29-114"><a href="#cb29-114"></a>            s <span class="op">=</span> s<span class="op">+</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb29-115"><a href="#cb29-115"></a>        v <span class="op">=</span> v<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb29-116"><a href="#cb29-116"></a>    <span class="op">}</span></span>
<span id="cb29-117"><a href="#cb29-117"></a>    <span class="cf">return</span> s<span class="op">;</span></span>
<span id="cb29-118"><a href="#cb29-118"></a><span class="op">}</span></span>
<span id="cb29-119"><a href="#cb29-119"></a></span>
<span id="cb29-120"><a href="#cb29-120"></a><span class="dt">int</span> popcount<span class="op">(</span><span class="dt">uint64_t</span> v<span class="op">)</span></span>
<span id="cb29-121"><a href="#cb29-121"></a><span class="op">{</span></span>
<span id="cb29-122"><a href="#cb29-122"></a>    <span class="dt">uint64_t</span> mask_1 <span class="op">=</span> <span class="bn">0x5555555555555555</span><span class="op">;</span></span>
<span id="cb29-123"><a href="#cb29-123"></a>    <span class="dt">uint64_t</span> mask_2 <span class="op">=</span> <span class="bn">0x3333333333333333</span><span class="op">;</span></span>
<span id="cb29-124"><a href="#cb29-124"></a>    <span class="dt">uint64_t</span> mask_3 <span class="op">=</span> <span class="bn">0x0f0f0f0f0f0f0f0f</span><span class="op">;</span></span>
<span id="cb29-125"><a href="#cb29-125"></a>    <span class="dt">uint64_t</span> mask_4 <span class="op">=</span> <span class="bn">0x00ff00ff00ff00ff</span><span class="op">;</span></span>
<span id="cb29-126"><a href="#cb29-126"></a>    <span class="dt">uint64_t</span> mask_5 <span class="op">=</span> <span class="bn">0x0000ffff0000ffff</span><span class="op">;</span></span>
<span id="cb29-127"><a href="#cb29-127"></a>    <span class="dt">uint64_t</span> mask_6 <span class="op">=</span> <span class="bn">0x00000000ffffffff</span><span class="op">;</span></span>
<span id="cb29-128"><a href="#cb29-128"></a></span>
<span id="cb29-129"><a href="#cb29-129"></a>    v <span class="op">=</span> <span class="op">(</span>v <span class="op">&amp;</span> mask_1<span class="op">)</span> <span class="op">+</span> <span class="op">((</span>v <span class="op">&amp;</span> <span class="op">(</span>mask_1 <span class="op">&lt;&lt;</span> <span class="dv">1</span><span class="op">))</span> <span class="op">&gt;&gt;</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb29-130"><a href="#cb29-130"></a>    v <span class="op">=</span> <span class="op">(</span>v <span class="op">&amp;</span> mask_2<span class="op">)</span> <span class="op">+</span> <span class="op">((</span>v <span class="op">&amp;</span> <span class="op">(</span>mask_2 <span class="op">&lt;&lt;</span> <span class="dv">2</span><span class="op">))</span> <span class="op">&gt;&gt;</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb29-131"><a href="#cb29-131"></a>    v <span class="op">=</span> <span class="op">(</span>v <span class="op">&amp;</span> mask_3<span class="op">)</span> <span class="op">+</span> <span class="op">((</span>v <span class="op">&amp;</span> <span class="op">(</span>mask_3 <span class="op">&lt;&lt;</span> <span class="dv">4</span><span class="op">))</span> <span class="op">&gt;&gt;</span> <span class="dv">4</span><span class="op">);</span></span>
<span id="cb29-132"><a href="#cb29-132"></a>    v <span class="op">=</span> <span class="op">(</span>v <span class="op">&amp;</span> mask_4<span class="op">)</span> <span class="op">+</span> <span class="op">((</span>v <span class="op">&amp;</span> <span class="op">(</span>mask_4 <span class="op">&lt;&lt;</span> <span class="dv">8</span><span class="op">))</span> <span class="op">&gt;&gt;</span> <span class="dv">8</span><span class="op">);</span></span>
<span id="cb29-133"><a href="#cb29-133"></a>    v <span class="op">=</span> <span class="op">(</span>v <span class="op">&amp;</span> mask_5<span class="op">)</span> <span class="op">+</span> <span class="op">((</span>v <span class="op">&amp;</span> <span class="op">(</span>mask_5 <span class="op">&lt;&lt;</span> <span class="dv">16</span><span class="op">))</span> <span class="op">&gt;&gt;</span> <span class="dv">16</span><span class="op">);</span></span>
<span id="cb29-134"><a href="#cb29-134"></a>    v <span class="op">=</span> <span class="op">(</span>v <span class="op">&amp;</span> mask_6<span class="op">)</span> <span class="op">+</span> <span class="op">((</span>v <span class="op">&amp;</span> <span class="op">(</span>mask_6 <span class="op">&lt;&lt;</span> <span class="dv">32</span><span class="op">))</span> <span class="op">&gt;&gt;</span> <span class="dv">32</span><span class="op">);</span></span>
<span id="cb29-135"><a href="#cb29-135"></a></span>
<span id="cb29-136"><a href="#cb29-136"></a>    <span class="cf">return</span> v<span class="op">;</span></span>
<span id="cb29-137"><a href="#cb29-137"></a><span class="op">}</span></span>
<span id="cb29-138"><a href="#cb29-138"></a></span>
<span id="cb29-139"><a href="#cb29-139"></a><span class="pp">#define popcount __builtin_popcountll</span></span>
<span id="cb29-140"><a href="#cb29-140"></a></span>
<span id="cb29-141"><a href="#cb29-141"></a><span class="dt">int</span> enum_popcount_byte<span class="op">[</span><span class="dv">256</span><span class="op">];</span></span>
<span id="cb29-142"><a href="#cb29-142"></a></span>
<span id="cb29-143"><a href="#cb29-143"></a><span class="dt">void</span> print_board<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">)</span></span>
<span id="cb29-144"><a href="#cb29-144"></a><span class="op">{</span></span>
<span id="cb29-145"><a href="#cb29-145"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">64</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb29-146"><a href="#cb29-146"></a>    <span class="op">{</span></span>
<span id="cb29-147"><a href="#cb29-147"></a>        <span class="cf">if</span> <span class="op">(((</span>b <span class="op">&gt;&gt;</span> i<span class="op">)</span> <span class="op">&amp;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb29-148"><a href="#cb29-148"></a>            putchar<span class="op">(</span><span class="ch">&#39;#&#39;</span><span class="op">);</span></span>
<span id="cb29-149"><a href="#cb29-149"></a>        <span class="cf">else</span> <span class="cf">if</span> <span class="op">(((</span>p<span class="op">-&gt;</span>monsters <span class="op">&gt;&gt;</span> i<span class="op">)</span> <span class="op">&amp;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb29-150"><a href="#cb29-150"></a>            putchar<span class="op">(</span><span class="ch">&#39;M&#39;</span><span class="op">);</span></span>
<span id="cb29-151"><a href="#cb29-151"></a>        <span class="cf">else</span> <span class="cf">if</span> <span class="op">(((</span>p<span class="op">-&gt;</span>treasures <span class="op">&gt;&gt;</span> i<span class="op">)</span> <span class="op">&amp;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb29-152"><a href="#cb29-152"></a>            putchar<span class="op">(</span><span class="ch">&#39;T&#39;</span><span class="op">);</span></span>
<span id="cb29-153"><a href="#cb29-153"></a>        <span class="cf">else</span> putchar<span class="op">(</span><span class="ch">&#39;.&#39;</span><span class="op">);</span></span>
<span id="cb29-154"><a href="#cb29-154"></a></span>
<span id="cb29-155"><a href="#cb29-155"></a>        <span class="cf">if</span> <span class="op">(</span>i <span class="op">%</span> <span class="dv">8</span> <span class="op">==</span> <span class="dv">7</span><span class="op">)</span> printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb29-156"><a href="#cb29-156"></a>    <span class="op">}</span></span>
<span id="cb29-157"><a href="#cb29-157"></a><span class="op">}</span></span>
<span id="cb29-158"><a href="#cb29-158"></a></span>
<span id="cb29-159"><a href="#cb29-159"></a><span class="dt">uint64_t</span> bit<span class="op">(</span><span class="dt">int</span> pos<span class="op">)</span></span>
<span id="cb29-160"><a href="#cb29-160"></a><span class="op">{</span></span>
<span id="cb29-161"><a href="#cb29-161"></a>    <span class="cf">return</span> <span class="op">(</span><span class="dt">uint64_t</span><span class="op">)</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> pos<span class="op">;</span></span>
<span id="cb29-162"><a href="#cb29-162"></a><span class="op">}</span></span>
<span id="cb29-163"><a href="#cb29-163"></a></span>
<span id="cb29-164"><a href="#cb29-164"></a><span class="dt">uint64_t</span> neighbours<span class="op">(</span><span class="dt">int</span> pos<span class="op">)</span></span>
<span id="cb29-165"><a href="#cb29-165"></a><span class="op">{</span></span>
<span id="cb29-166"><a href="#cb29-166"></a>    <span class="dt">uint64_t</span> mask <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb29-167"><a href="#cb29-167"></a>    <span class="cf">if</span> <span class="op">(</span>pos <span class="op">%</span> <span class="dv">8</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb29-168"><a href="#cb29-168"></a>        mask <span class="op">|=</span> bit<span class="op">(</span>pos <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb29-169"><a href="#cb29-169"></a>    <span class="cf">if</span> <span class="op">(</span>pos <span class="op">%</span> <span class="dv">8</span> <span class="op">!=</span> <span class="dv">7</span><span class="op">)</span></span>
<span id="cb29-170"><a href="#cb29-170"></a>        mask <span class="op">|=</span> bit<span class="op">(</span>pos <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb29-171"><a href="#cb29-171"></a>    <span class="cf">if</span> <span class="op">(</span>pos <span class="op">&gt;</span> <span class="dv">7</span><span class="op">)</span></span>
<span id="cb29-172"><a href="#cb29-172"></a>        mask <span class="op">|=</span> bit<span class="op">(</span>pos <span class="op">-</span> <span class="dv">8</span><span class="op">);</span></span>
<span id="cb29-173"><a href="#cb29-173"></a>    <span class="cf">if</span> <span class="op">(</span>pos <span class="op">&lt;</span> <span class="dv">56</span><span class="op">)</span></span>
<span id="cb29-174"><a href="#cb29-174"></a>        mask <span class="op">|=</span> bit<span class="op">(</span>pos <span class="op">+</span> <span class="dv">8</span><span class="op">);</span></span>
<span id="cb29-175"><a href="#cb29-175"></a>    <span class="cf">return</span> mask<span class="op">;</span></span>
<span id="cb29-176"><a href="#cb29-176"></a><span class="op">}</span></span>
<span id="cb29-177"><a href="#cb29-177"></a></span>
<span id="cb29-178"><a href="#cb29-178"></a><span class="dt">int</span> count_non_wall<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">,</span> <span class="dt">int</span> pos<span class="op">)</span></span>
<span id="cb29-179"><a href="#cb29-179"></a><span class="op">{</span></span>
<span id="cb29-180"><a href="#cb29-180"></a>    <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb29-181"><a href="#cb29-181"></a>    <span class="dt">uint64_t</span> mask <span class="op">=</span> neighbours<span class="op">(</span>pos<span class="op">);</span></span>
<span id="cb29-182"><a href="#cb29-182"></a>    <span class="cf">return</span> popcount<span class="op">(~</span>b <span class="op">&amp;</span> mask<span class="op">);</span> </span>
<span id="cb29-183"><a href="#cb29-183"></a><span class="op">}</span></span>
<span id="cb29-184"><a href="#cb29-184"></a></span>
<span id="cb29-185"><a href="#cb29-185"></a><span class="dt">bool</span> empty<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">,</span> <span class="dt">int</span> pos<span class="op">)</span></span>
<span id="cb29-186"><a href="#cb29-186"></a><span class="op">{</span></span>
<span id="cb29-187"><a href="#cb29-187"></a>    board fb <span class="op">=</span> b <span class="op">|</span> p<span class="op">-&gt;</span>monsters <span class="op">|</span> p<span class="op">-&gt;</span>treasures<span class="op">;</span></span>
<span id="cb29-188"><a href="#cb29-188"></a></span>
<span id="cb29-189"><a href="#cb29-189"></a>    <span class="cf">return</span> <span class="op">(</span>fb <span class="op">&amp;</span> bit<span class="op">(</span>pos<span class="op">))</span> <span class="op">==</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb29-190"><a href="#cb29-190"></a><span class="op">}</span></span>
<span id="cb29-191"><a href="#cb29-191"></a></span>
<span id="cb29-192"><a href="#cb29-192"></a><span class="dt">bool</span> treasure<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> <span class="dt">int</span> pos<span class="op">)</span></span>
<span id="cb29-193"><a href="#cb29-193"></a><span class="op">{</span></span>
<span id="cb29-194"><a href="#cb29-194"></a>    <span class="cf">return</span> p<span class="op">-&gt;</span>treasures <span class="op">&amp;</span> bit<span class="op">(</span>pos<span class="op">);</span></span>
<span id="cb29-195"><a href="#cb29-195"></a><span class="op">}</span></span>
<span id="cb29-196"><a href="#cb29-196"></a></span>
<span id="cb29-197"><a href="#cb29-197"></a><span class="dt">bool</span> monster<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> <span class="dt">int</span> pos<span class="op">)</span></span>
<span id="cb29-198"><a href="#cb29-198"></a><span class="op">{</span></span>
<span id="cb29-199"><a href="#cb29-199"></a>    <span class="cf">return</span> p<span class="op">-&gt;</span>monsters <span class="op">&amp;</span> bit<span class="op">(</span>pos<span class="op">);</span></span>
<span id="cb29-200"><a href="#cb29-200"></a><span class="op">}</span></span>
<span id="cb29-201"><a href="#cb29-201"></a></span>
<span id="cb29-202"><a href="#cb29-202"></a><span class="dt">int</span> enum_byte<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">16</span><span class="op">,</span> <span class="dv">32</span><span class="op">,</span> <span class="dv">64</span><span class="op">,</span> <span class="dv">128</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">17</span><span class="op">,</span> <span class="dv">18</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="dv">24</span><span class="op">,</span> <span class="dv">33</span><span class="op">,</span> <span class="dv">34</span><span class="op">,</span> <span class="dv">36</span><span class="op">,</span> <span class="dv">40</span><span class="op">,</span> <span class="dv">48</span><span class="op">,</span> <span class="dv">65</span><span class="op">,</span> <span class="dv">66</span><span class="op">,</span> <span class="dv">68</span><span class="op">,</span> <span class="dv">72</span><span class="op">,</span> <span class="dv">80</span><span class="op">,</span> <span class="dv">96</span><span class="op">,</span> <span class="dv">129</span><span class="op">,</span> <span class="dv">130</span><span class="op">,</span> <span class="dv">132</span><span class="op">,</span> <span class="dv">136</span><span class="op">,</span> <span class="dv">144</span><span class="op">,</span> <span class="dv">160</span><span class="op">,</span> <span class="dv">192</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">11</span><span class="op">,</span> <span class="dv">13</span><span class="op">,</span> <span class="dv">14</span><span class="op">,</span> <span class="dv">19</span><span class="op">,</span> <span class="dv">21</span><span class="op">,</span> <span class="dv">22</span><span class="op">,</span> <span class="dv">25</span><span class="op">,</span> <span class="dv">26</span><span class="op">,</span> <span class="dv">28</span><span class="op">,</span> <span class="dv">35</span><span class="op">,</span> <span class="dv">37</span><span class="op">,</span> <span class="dv">38</span><span class="op">,</span> <span class="dv">41</span><span class="op">,</span> <span class="dv">42</span><span class="op">,</span> <span class="dv">44</span><span class="op">,</span> <span class="dv">49</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">52</span><span class="op">,</span> <span class="dv">56</span><span class="op">,</span> <span class="dv">67</span><span class="op">,</span> <span class="dv">69</span><span class="op">,</span> <span class="dv">70</span><span class="op">,</span> <span class="dv">73</span><span class="op">,</span> <span class="dv">74</span><span class="op">,</span> <span class="dv">76</span><span class="op">,</span> <span class="dv">81</span><span class="op">,</span> <span class="dv">82</span><span class="op">,</span> <span class="dv">84</span><span class="op">,</span> <span class="dv">88</span><span class="op">,</span> <span class="dv">97</span><span class="op">,</span> <span class="dv">98</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> <span class="dv">104</span><span class="op">,</span> <span class="dv">112</span><span class="op">,</span> <span class="dv">131</span><span class="op">,</span> <span class="dv">133</span><span class="op">,</span> <span class="dv">134</span><span class="op">,</span> <span class="dv">137</span><span class="op">,</span> <span class="dv">138</span><span class="op">,</span> <span class="dv">140</span><span class="op">,</span> <span class="dv">145</span><span class="op">,</span> <span class="dv">146</span><span class="op">,</span> <span class="dv">148</span><span class="op">,</span> <span class="dv">152</span><span class="op">,</span> <span class="dv">161</span><span class="op">,</span> <span class="dv">162</span><span class="op">,</span> <span class="dv">164</span><span class="op">,</span> <span class="dv">168</span><span class="op">,</span> <span class="dv">176</span><span class="op">,</span> <span class="dv">193</span><span class="op">,</span> <span class="dv">194</span><span class="op">,</span> <span class="dv">196</span><span class="op">,</span> <span class="dv">200</span><span class="op">,</span> <span class="dv">208</span><span class="op">,</span> <span class="dv">224</span><span class="op">,</span> <span class="dv">15</span><span class="op">,</span> <span class="dv">23</span><span class="op">,</span> <span class="dv">27</span><span class="op">,</span> <span class="dv">29</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">39</span><span class="op">,</span> <span class="dv">43</span><span class="op">,</span> <span class="dv">45</span><span class="op">,</span> <span class="dv">46</span><span class="op">,</span> <span class="dv">51</span><span class="op">,</span> <span class="dv">53</span><span class="op">,</span> <span class="dv">54</span><span class="op">,</span> <span class="dv">57</span><span class="op">,</span> <span class="dv">58</span><span class="op">,</span> <span class="dv">60</span><span class="op">,</span> <span class="dv">71</span><span class="op">,</span> <span class="dv">75</span><span class="op">,</span> <span class="dv">77</span><span class="op">,</span> <span class="dv">78</span><span class="op">,</span> <span class="dv">83</span><span class="op">,</span> <span class="dv">85</span><span class="op">,</span> <span class="dv">86</span><span class="op">,</span> <span class="dv">89</span><span class="op">,</span> <span class="dv">90</span><span class="op">,</span> <span class="dv">92</span><span class="op">,</span> <span class="dv">99</span><span class="op">,</span> <span class="dv">101</span><span class="op">,</span> <span class="dv">102</span><span class="op">,</span> <span class="dv">105</span><span class="op">,</span> <span class="dv">106</span><span class="op">,</span> <span class="dv">108</span><span class="op">,</span> <span class="dv">113</span><span class="op">,</span> <span class="dv">114</span><span class="op">,</span> <span class="dv">116</span><span class="op">,</span> <span class="dv">120</span><span class="op">,</span> <span class="dv">135</span><span class="op">,</span> <span class="dv">139</span><span class="op">,</span> <span class="dv">141</span><span class="op">,</span> <span class="dv">142</span><span class="op">,</span> <span class="dv">147</span><span class="op">,</span> <span class="dv">149</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">153</span><span class="op">,</span> <span class="dv">154</span><span class="op">,</span> <span class="dv">156</span><span class="op">,</span> <span class="dv">163</span><span class="op">,</span> <span class="dv">165</span><span class="op">,</span> <span class="dv">166</span><span class="op">,</span> <span class="dv">169</span><span class="op">,</span> <span class="dv">170</span><span class="op">,</span> <span class="dv">172</span><span class="op">,</span> <span class="dv">177</span><span class="op">,</span> <span class="dv">178</span><span class="op">,</span> <span class="dv">180</span><span class="op">,</span> <span class="dv">184</span><span class="op">,</span> <span class="dv">195</span><span class="op">,</span> <span class="dv">197</span><span class="op">,</span> <span class="dv">198</span><span class="op">,</span> <span class="dv">201</span><span class="op">,</span> <span class="dv">202</span><span class="op">,</span> <span class="dv">204</span><span class="op">,</span> <span class="dv">209</span><span class="op">,</span> <span class="dv">210</span><span class="op">,</span> <span class="dv">212</span><span class="op">,</span> <span class="dv">216</span><span class="op">,</span> <span class="dv">225</span><span class="op">,</span> <span class="dv">226</span><span class="op">,</span> <span class="dv">228</span><span class="op">,</span> <span class="dv">232</span><span class="op">,</span> <span class="dv">240</span><span class="op">,</span> <span class="dv">31</span><span class="op">,</span> <span class="dv">47</span><span class="op">,</span> <span class="dv">55</span><span class="op">,</span> <span class="dv">59</span><span class="op">,</span> <span class="dv">61</span><span class="op">,</span> <span class="dv">62</span><span class="op">,</span> <span class="dv">79</span><span class="op">,</span> <span class="dv">87</span><span class="op">,</span> <span class="dv">91</span><span class="op">,</span> <span class="dv">93</span><span class="op">,</span> <span class="dv">94</span><span class="op">,</span> <span class="dv">103</span><span class="op">,</span> <span class="dv">107</span><span class="op">,</span> <span class="dv">109</span><span class="op">,</span> <span class="dv">110</span><span class="op">,</span> <span class="dv">115</span><span class="op">,</span> <span class="dv">117</span><span class="op">,</span> <span class="dv">118</span><span class="op">,</span> <span class="dv">121</span><span class="op">,</span> <span class="dv">122</span><span class="op">,</span> <span class="dv">124</span><span class="op">,</span> <span class="dv">143</span><span class="op">,</span> <span class="dv">151</span><span class="op">,</span> <span class="dv">155</span><span class="op">,</span> <span class="dv">157</span><span class="op">,</span> <span class="dv">158</span><span class="op">,</span> <span class="dv">167</span><span class="op">,</span> <span class="dv">171</span><span class="op">,</span> <span class="dv">173</span><span class="op">,</span> <span class="dv">174</span><span class="op">,</span> <span class="dv">179</span><span class="op">,</span> <span class="dv">181</span><span class="op">,</span> <span class="dv">182</span><span class="op">,</span> <span class="dv">185</span><span class="op">,</span> <span class="dv">186</span><span class="op">,</span> <span class="dv">188</span><span class="op">,</span> <span class="dv">199</span><span class="op">,</span> <span class="dv">203</span><span class="op">,</span> <span class="dv">205</span><span class="op">,</span> <span class="dv">206</span><span class="op">,</span> <span class="dv">211</span><span class="op">,</span> <span class="dv">213</span><span class="op">,</span> <span class="dv">214</span><span class="op">,</span> <span class="dv">217</span><span class="op">,</span> <span class="dv">218</span><span class="op">,</span> <span class="dv">220</span><span class="op">,</span> <span class="dv">227</span><span class="op">,</span> <span class="dv">229</span><span class="op">,</span> <span class="dv">230</span><span class="op">,</span> <span class="dv">233</span><span class="op">,</span> <span class="dv">234</span><span class="op">,</span> <span class="dv">236</span><span class="op">,</span> <span class="dv">241</span><span class="op">,</span> <span class="dv">242</span><span class="op">,</span> <span class="dv">244</span><span class="op">,</span> <span class="dv">248</span><span class="op">,</span> <span class="dv">63</span><span class="op">,</span> <span class="dv">95</span><span class="op">,</span> <span class="dv">111</span><span class="op">,</span> <span class="dv">119</span><span class="op">,</span> <span class="dv">123</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">126</span><span class="op">,</span> <span class="dv">159</span><span class="op">,</span> <span class="dv">175</span><span class="op">,</span> <span class="dv">183</span><span class="op">,</span> <span class="dv">187</span><span class="op">,</span> <span class="dv">189</span><span class="op">,</span> <span class="dv">190</span><span class="op">,</span> <span class="dv">207</span><span class="op">,</span> <span class="dv">215</span><span class="op">,</span> <span class="dv">219</span><span class="op">,</span> <span class="dv">221</span><span class="op">,</span> <span class="dv">222</span><span class="op">,</span> <span class="dv">231</span><span class="op">,</span> <span class="dv">235</span><span class="op">,</span> <span class="dv">237</span><span class="op">,</span> <span class="dv">238</span><span class="op">,</span> <span class="dv">243</span><span class="op">,</span> <span class="dv">245</span><span class="op">,</span> <span class="dv">246</span><span class="op">,</span> <span class="dv">249</span><span class="op">,</span> <span class="dv">250</span><span class="op">,</span> <span class="dv">252</span><span class="op">,</span> <span class="dv">127</span><span class="op">,</span> <span class="dv">191</span><span class="op">,</span> <span class="dv">223</span><span class="op">,</span> <span class="dv">239</span><span class="op">,</span> <span class="dv">247</span><span class="op">,</span> <span class="dv">251</span><span class="op">,</span> <span class="dv">253</span><span class="op">,</span> <span class="dv">254</span><span class="op">,</span> <span class="dv">255</span> <span class="op">};</span></span>
<span id="cb29-203"><a href="#cb29-203"></a><span class="dt">int</span> enum_byte_idx<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">37</span><span class="op">,</span> <span class="dv">93</span><span class="op">,</span> <span class="dv">163</span><span class="op">,</span> <span class="dv">219</span><span class="op">,</span> <span class="dv">247</span><span class="op">,</span> <span class="dv">255</span><span class="op">,</span> <span class="dv">256</span> <span class="op">};</span></span>
<span id="cb29-204"><a href="#cb29-204"></a></span>
<span id="cb29-205"><a href="#cb29-205"></a><span class="dt">bool</span> test_columns_overload<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">)</span></span>
<span id="cb29-206"><a href="#cb29-206"></a><span class="op">{</span></span>
<span id="cb29-207"><a href="#cb29-207"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> col <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> col <span class="op">&lt;</span> <span class="dv">8</span><span class="op">;</span> col<span class="op">++)</span></span>
<span id="cb29-208"><a href="#cb29-208"></a>        <span class="cf">if</span> <span class="op">(</span>popcount<span class="op">(</span>b <span class="op">&amp;</span> mask_column<span class="op">(</span>col<span class="op">))</span> <span class="op">&gt;</span> p<span class="op">-&gt;</span>columns<span class="op">[</span>col<span class="op">])</span></span>
<span id="cb29-209"><a href="#cb29-209"></a>            <span class="cf">return</span> true<span class="op">;</span></span>
<span id="cb29-210"><a href="#cb29-210"></a>    <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb29-211"><a href="#cb29-211"></a><span class="op">}</span></span>
<span id="cb29-212"><a href="#cb29-212"></a></span>
<span id="cb29-213"><a href="#cb29-213"></a><span class="dt">bool</span> test_columns_underload<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">)</span></span>
<span id="cb29-214"><a href="#cb29-214"></a><span class="op">{</span></span>
<span id="cb29-215"><a href="#cb29-215"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> col <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> col <span class="op">&lt;</span> <span class="dv">8</span><span class="op">;</span> col<span class="op">++)</span></span>
<span id="cb29-216"><a href="#cb29-216"></a>        <span class="cf">if</span> <span class="op">(</span>popcount<span class="op">(</span>b <span class="op">&amp;</span> mask_column<span class="op">(</span>col<span class="op">))</span> <span class="op">&lt;</span> p<span class="op">-&gt;</span>columns<span class="op">[</span>col<span class="op">])</span></span>
<span id="cb29-217"><a href="#cb29-217"></a>            <span class="cf">return</span> true<span class="op">;</span></span>
<span id="cb29-218"><a href="#cb29-218"></a>    <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb29-219"><a href="#cb29-219"></a><span class="op">}</span></span>
<span id="cb29-220"><a href="#cb29-220"></a></span>
<span id="cb29-221"><a href="#cb29-221"></a><span class="dt">bool</span> test_no_deadend_upto_row<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">,</span> <span class="dt">int</span> row<span class="op">)</span></span>
<span id="cb29-222"><a href="#cb29-222"></a><span class="op">{</span></span>
<span id="cb29-223"><a href="#cb29-223"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">8</span><span class="op">*</span>row<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb29-224"><a href="#cb29-224"></a>    <span class="op">{</span></span>
<span id="cb29-225"><a href="#cb29-225"></a>        <span class="cf">if</span> <span class="op">(</span>empty<span class="op">(</span>p<span class="op">,</span>b<span class="op">,</span>i<span class="op">)</span> <span class="op">&amp;&amp;</span> count_non_wall<span class="op">(</span>p<span class="op">,</span> b<span class="op">,</span> i<span class="op">)</span> <span class="op">&lt;=</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb29-226"><a href="#cb29-226"></a>            <span class="cf">return</span> true<span class="op">;</span></span>
<span id="cb29-227"><a href="#cb29-227"></a>    <span class="op">}</span></span>
<span id="cb29-228"><a href="#cb29-228"></a>    <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb29-229"><a href="#cb29-229"></a><span class="op">}</span></span>
<span id="cb29-230"><a href="#cb29-230"></a></span>
<span id="cb29-231"><a href="#cb29-231"></a><span class="dt">bool</span> test_trapped_monster<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">)</span></span>
<span id="cb29-232"><a href="#cb29-232"></a><span class="op">{</span></span>
<span id="cb29-233"><a href="#cb29-233"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">64</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb29-234"><a href="#cb29-234"></a>        <span class="cf">if</span> <span class="op">(</span>monster<span class="op">(</span>p<span class="op">,</span>i<span class="op">)</span> <span class="op">&amp;&amp;</span> count_non_wall<span class="op">(</span>p<span class="op">,</span> b<span class="op">,</span> i<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb29-235"><a href="#cb29-235"></a>            <span class="cf">return</span> true<span class="op">;</span></span>
<span id="cb29-236"><a href="#cb29-236"></a>    <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb29-237"><a href="#cb29-237"></a><span class="op">}</span></span>
<span id="cb29-238"><a href="#cb29-238"></a></span>
<span id="cb29-239"><a href="#cb29-239"></a><span class="dt">bool</span> test_deadends<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">)</span></span>
<span id="cb29-240"><a href="#cb29-240"></a><span class="op">{</span></span>
<span id="cb29-241"><a href="#cb29-241"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">64</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb29-242"><a href="#cb29-242"></a>    <span class="op">{</span></span>
<span id="cb29-243"><a href="#cb29-243"></a>        <span class="co">// Empty cell must not be a dead-end</span></span>
<span id="cb29-244"><a href="#cb29-244"></a>        <span class="cf">if</span> <span class="op">(</span>empty<span class="op">(</span>p<span class="op">,</span>b<span class="op">,</span>i<span class="op">)</span> <span class="op">&amp;&amp;</span> count_non_wall<span class="op">(</span>p<span class="op">,</span> b<span class="op">,</span> i<span class="op">)</span> <span class="op">&lt;=</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb29-245"><a href="#cb29-245"></a>            <span class="cf">return</span> true<span class="op">;</span></span>
<span id="cb29-246"><a href="#cb29-246"></a>        <span class="co">// Monsters must be a dead-end</span></span>
<span id="cb29-247"><a href="#cb29-247"></a>        <span class="cf">if</span> <span class="op">(</span>monster<span class="op">(</span>p<span class="op">,</span>i<span class="op">)</span> <span class="op">&amp;&amp;</span> count_non_wall<span class="op">(</span>p<span class="op">,</span> b<span class="op">,</span> i<span class="op">)</span> <span class="op">!=</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb29-248"><a href="#cb29-248"></a>            <span class="cf">return</span> true<span class="op">;</span></span>
<span id="cb29-249"><a href="#cb29-249"></a>    <span class="op">}</span></span>
<span id="cb29-250"><a href="#cb29-250"></a></span>
<span id="cb29-251"><a href="#cb29-251"></a>    <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb29-252"><a href="#cb29-252"></a><span class="op">}</span></span>
<span id="cb29-253"><a href="#cb29-253"></a></span>
<span id="cb29-254"><a href="#cb29-254"></a><span class="dt">bool</span> test_treasure_rooms<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board <span class="op">*</span>b<span class="op">)</span></span>
<span id="cb29-255"><a href="#cb29-255"></a><span class="op">{</span></span>
<span id="cb29-256"><a href="#cb29-256"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">64</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb29-257"><a href="#cb29-257"></a>    <span class="op">{</span></span>
<span id="cb29-258"><a href="#cb29-258"></a>        <span class="cf">if</span><span class="op">(</span>treasure<span class="op">(</span>p<span class="op">,</span>i<span class="op">))</span></span>
<span id="cb29-259"><a href="#cb29-259"></a>        <span class="op">{</span></span>
<span id="cb29-260"><a href="#cb29-260"></a>            <span class="dt">int</span> x <span class="op">=</span> i <span class="op">%</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb29-261"><a href="#cb29-261"></a>            <span class="dt">int</span> y <span class="op">=</span> i <span class="op">/</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb29-262"><a href="#cb29-262"></a>            <span class="dt">int</span> minx <span class="op">=</span> x <span class="op">-</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb29-263"><a href="#cb29-263"></a>            <span class="cf">if</span> <span class="op">(</span>minx <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> minx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb29-264"><a href="#cb29-264"></a>            <span class="dt">int</span> miny <span class="op">=</span> y <span class="op">-</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb29-265"><a href="#cb29-265"></a>            <span class="cf">if</span> <span class="op">(</span>miny <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> miny <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb29-266"><a href="#cb29-266"></a>            <span class="co">// starting point of the treasure room</span></span>
<span id="cb29-267"><a href="#cb29-267"></a>            <span class="co">//    xxx</span></span>
<span id="cb29-268"><a href="#cb29-268"></a>            <span class="co">//    xTx</span></span>
<span id="cb29-269"><a href="#cb29-269"></a>            <span class="co">//    xxx</span></span>
<span id="cb29-270"><a href="#cb29-270"></a>            <span class="dt">bool</span> found <span class="op">=</span> false<span class="op">;</span></span>
<span id="cb29-271"><a href="#cb29-271"></a>            <span class="dt">uint64_t</span> room <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> </span>
<span id="cb29-272"><a href="#cb29-272"></a>            <span class="dt">int</span> sx<span class="op">,</span> sy<span class="op">;</span></span>
<span id="cb29-273"><a href="#cb29-273"></a></span>
<span id="cb29-274"><a href="#cb29-274"></a>            <span class="cf">for</span><span class="op">(</span>sy <span class="op">=</span> miny<span class="op">;</span> sy <span class="op">&lt;=</span> y<span class="op">;</span> sy<span class="op">++)</span></span>
<span id="cb29-275"><a href="#cb29-275"></a>            <span class="op">{</span></span>
<span id="cb29-276"><a href="#cb29-276"></a>                <span class="cf">for</span><span class="op">(</span>sx <span class="op">=</span> minx<span class="op">;</span> sx <span class="op">&lt;=</span> x<span class="op">;</span> sx<span class="op">++)</span></span>
<span id="cb29-277"><a href="#cb29-277"></a>                <span class="op">{</span></span>
<span id="cb29-278"><a href="#cb29-278"></a>                    room <span class="op">=</span> <span class="op">(</span><span class="dt">uint64_t</span><span class="op">)</span><span class="bn">0x070707</span>  <span class="op">&lt;&lt;</span> <span class="op">(</span>sx <span class="op">+</span> <span class="dv">8</span><span class="op">*</span>sy<span class="op">);</span></span>
<span id="cb29-279"><a href="#cb29-279"></a>                    <span class="cf">if</span> <span class="op">(</span>popcount<span class="op">(~(*</span>b<span class="op">)</span> <span class="op">&amp;</span> room<span class="op">)</span> <span class="op">==</span> <span class="dv">9</span><span class="op">)</span></span>
<span id="cb29-280"><a href="#cb29-280"></a>                    <span class="op">{</span></span>
<span id="cb29-281"><a href="#cb29-281"></a>                        found <span class="op">=</span> true<span class="op">;</span></span>
<span id="cb29-282"><a href="#cb29-282"></a>                        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb29-283"><a href="#cb29-283"></a>                    <span class="op">}</span></span>
<span id="cb29-284"><a href="#cb29-284"></a>                <span class="op">}</span></span>
<span id="cb29-285"><a href="#cb29-285"></a>                <span class="cf">if</span><span class="op">(</span>found<span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb29-286"><a href="#cb29-286"></a>            <span class="op">}</span></span>
<span id="cb29-287"><a href="#cb29-287"></a></span>
<span id="cb29-288"><a href="#cb29-288"></a>            <span class="cf">if</span> <span class="op">(!</span>found<span class="op">)</span> <span class="cf">return</span> true<span class="op">;</span></span>
<span id="cb29-289"><a href="#cb29-289"></a>            <span class="dt">uint64_t</span> border <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb29-290"><a href="#cb29-290"></a>            <span class="cf">if</span> <span class="op">(</span>sy <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb29-291"><a href="#cb29-291"></a>                border <span class="op">|=</span> <span class="op">(</span><span class="dt">uint64_t</span><span class="op">)</span><span class="bn">0x07</span> <span class="op">&lt;&lt;</span> <span class="op">(</span>sx<span class="op">+</span><span class="dv">8</span><span class="op">*(</span>sy<span class="op">-</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb29-292"><a href="#cb29-292"></a>            <span class="cf">if</span> <span class="op">(</span>sy<span class="op">+</span><span class="dv">2</span> <span class="op">&lt;</span> <span class="dv">7</span><span class="op">)</span></span>
<span id="cb29-293"><a href="#cb29-293"></a>                border <span class="op">|=</span> <span class="op">(</span><span class="dt">uint64_t</span><span class="op">)</span><span class="bn">0x07</span> <span class="op">&lt;&lt;</span> <span class="op">(</span>sx<span class="op">+</span><span class="dv">8</span><span class="op">*(</span>sy<span class="op">+</span><span class="dv">3</span><span class="op">));</span></span>
<span id="cb29-294"><a href="#cb29-294"></a>            <span class="cf">if</span> <span class="op">(</span>sx <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb29-295"><a href="#cb29-295"></a>                border <span class="op">|=</span> <span class="op">(</span><span class="dt">uint64_t</span><span class="op">)</span><span class="bn">0x010101</span> <span class="op">&lt;&lt;</span> <span class="op">(</span>sx<span class="op">-</span><span class="dv">1</span><span class="op">+</span><span class="dv">8</span><span class="op">*</span>sy<span class="op">);</span></span>
<span id="cb29-296"><a href="#cb29-296"></a>            <span class="cf">if</span> <span class="op">(</span>sx<span class="op">+</span><span class="dv">2</span> <span class="op">&lt;</span> <span class="dv">7</span><span class="op">)</span></span>
<span id="cb29-297"><a href="#cb29-297"></a>                border <span class="op">|=</span> <span class="op">(</span><span class="dt">uint64_t</span><span class="op">)</span><span class="bn">0x010101</span> <span class="op">&lt;&lt;</span> <span class="op">(</span>sx<span class="op">+</span><span class="dv">3</span><span class="op">+</span><span class="dv">8</span><span class="op">*</span>sy<span class="op">);</span></span>
<span id="cb29-298"><a href="#cb29-298"></a></span>
<span id="cb29-299"><a href="#cb29-299"></a>            <span class="dt">int</span> exit <span class="op">=</span> popcount<span class="op">(~(*</span>b<span class="op">)</span> <span class="op">&amp;</span> border<span class="op">);</span></span>
<span id="cb29-300"><a href="#cb29-300"></a>            <span class="cf">if</span> <span class="op">(</span>exit <span class="op">!=</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb29-301"><a href="#cb29-301"></a>                <span class="cf">return</span> true<span class="op">;</span></span>
<span id="cb29-302"><a href="#cb29-302"></a></span>
<span id="cb29-303"><a href="#cb29-303"></a>            <span class="op">*</span>b <span class="op">=</span> <span class="op">*</span>b <span class="op">|</span> room<span class="op">;</span></span>
<span id="cb29-304"><a href="#cb29-304"></a>        <span class="op">}</span></span>
<span id="cb29-305"><a href="#cb29-305"></a>    <span class="op">}</span></span>
<span id="cb29-306"><a href="#cb29-306"></a></span>
<span id="cb29-307"><a href="#cb29-307"></a>    <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb29-308"><a href="#cb29-308"></a><span class="op">}</span></span>
<span id="cb29-309"><a href="#cb29-309"></a></span>
<span id="cb29-310"><a href="#cb29-310"></a><span class="dt">bool</span> test_empty_squares<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> board b<span class="op">)</span></span>
<span id="cb29-311"><a href="#cb29-311"></a><span class="op">{</span></span>
<span id="cb29-312"><a href="#cb29-312"></a>    <span class="dt">uint64_t</span> mask_square <span class="op">=</span> <span class="bn">0x0303</span><span class="op">;</span></span>
<span id="cb29-313"><a href="#cb29-313"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">7</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb29-314"><a href="#cb29-314"></a>    <span class="op">{</span></span>
<span id="cb29-315"><a href="#cb29-315"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="dv">7</span><span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb29-316"><a href="#cb29-316"></a>        <span class="op">{</span></span>
<span id="cb29-317"><a href="#cb29-317"></a>            <span class="cf">if</span><span class="op">((</span>b <span class="op">&amp;</span> mask_square<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb29-318"><a href="#cb29-318"></a>                <span class="cf">return</span> true<span class="op">;</span></span>
<span id="cb29-319"><a href="#cb29-319"></a>            mask_square <span class="op">*=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb29-320"><a href="#cb29-320"></a>        <span class="op">}</span></span>
<span id="cb29-321"><a href="#cb29-321"></a>        mask_square <span class="op">*=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb29-322"><a href="#cb29-322"></a>    <span class="op">}</span></span>
<span id="cb29-323"><a href="#cb29-323"></a></span>
<span id="cb29-324"><a href="#cb29-324"></a>    <span class="cf">return</span> false<span class="op">;</span></span>
<span id="cb29-325"><a href="#cb29-325"></a><span class="op">}</span></span>
<span id="cb29-326"><a href="#cb29-326"></a></span>
<span id="cb29-327"><a href="#cb29-327"></a><span class="dt">void</span> solve<span class="op">(</span>problem <span class="op">*</span>p<span class="op">,</span> <span class="dt">int</span> row<span class="op">,</span> board b<span class="op">)</span></span>
<span id="cb29-328"><a href="#cb29-328"></a><span class="op">{</span></span>
<span id="cb29-329"><a href="#cb29-329"></a>    <span class="co">// Unsolvable from this board</span></span>
<span id="cb29-330"><a href="#cb29-330"></a>    <span class="cf">if</span> <span class="op">(</span>test_columns_overload<span class="op">(</span>p<span class="op">,</span> b<span class="op">))</span></span>
<span id="cb29-331"><a href="#cb29-331"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb29-332"><a href="#cb29-332"></a>    <span class="cf">if</span> <span class="op">(</span>test_no_deadend_upto_row<span class="op">(</span>p<span class="op">,</span> b<span class="op">,</span> row<span class="op">))</span></span>
<span id="cb29-333"><a href="#cb29-333"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb29-334"><a href="#cb29-334"></a>    <span class="cf">if</span> <span class="op">(</span>test_trapped_monster<span class="op">(</span>p<span class="op">,</span> b<span class="op">))</span></span>
<span id="cb29-335"><a href="#cb29-335"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb29-336"><a href="#cb29-336"></a></span>
<span id="cb29-337"><a href="#cb29-337"></a>    <span class="co">// Board is filled</span></span>
<span id="cb29-338"><a href="#cb29-338"></a>    <span class="cf">if</span><span class="op">(</span>row <span class="op">==</span> <span class="dv">8</span><span class="op">)</span></span>
<span id="cb29-339"><a href="#cb29-339"></a>    <span class="op">{</span></span>
<span id="cb29-340"><a href="#cb29-340"></a>        <span class="co">// Validate columns count</span></span>
<span id="cb29-341"><a href="#cb29-341"></a>        <span class="cf">if</span> <span class="op">(</span>test_columns_underload<span class="op">(</span>p<span class="op">,</span> b<span class="op">))</span></span>
<span id="cb29-342"><a href="#cb29-342"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb29-343"><a href="#cb29-343"></a></span>
<span id="cb29-344"><a href="#cb29-344"></a>        <span class="co">// Full board with monsters</span></span>
<span id="cb29-345"><a href="#cb29-345"></a>        board fb <span class="op">=</span> b <span class="op">|</span> p<span class="op">-&gt;</span>monsters<span class="op">;</span></span>
<span id="cb29-346"><a href="#cb29-346"></a></span>
<span id="cb29-347"><a href="#cb29-347"></a>        <span class="cf">if</span> <span class="op">(</span>test_treasure_rooms<span class="op">(</span>p<span class="op">,</span> <span class="op">&amp;</span>fb<span class="op">))</span></span>
<span id="cb29-348"><a href="#cb29-348"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb29-349"><a href="#cb29-349"></a>        <span class="co">// Every treasure room is now filled in fb</span></span>
<span id="cb29-350"><a href="#cb29-350"></a></span>
<span id="cb29-351"><a href="#cb29-351"></a>        <span class="cf">if</span> <span class="op">(</span>test_empty_squares<span class="op">(</span>p<span class="op">,</span> fb<span class="op">))</span></span>
<span id="cb29-352"><a href="#cb29-352"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb29-353"><a href="#cb29-353"></a></span>
<span id="cb29-354"><a href="#cb29-354"></a>        printf<span class="op">(</span><span class="st">&quot;Solution %lx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> b<span class="op">);</span> </span>
<span id="cb29-355"><a href="#cb29-355"></a>        print_board<span class="op">(</span>p<span class="op">,</span> b<span class="op">);</span></span>
<span id="cb29-356"><a href="#cb29-356"></a></span>
<span id="cb29-357"><a href="#cb29-357"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb29-358"><a href="#cb29-358"></a>    <span class="op">}</span></span>
<span id="cb29-359"><a href="#cb29-359"></a></span>
<span id="cb29-360"><a href="#cb29-360"></a>    <span class="co">/*</span></span>
<span id="cb29-361"><a href="#cb29-361"></a><span class="co">    // Slower because of branching </span></span>
<span id="cb29-362"><a href="#cb29-362"></a><span class="co">    for(int i = 0; i &lt; 256; i++)</span></span>
<span id="cb29-363"><a href="#cb29-363"></a><span class="co">        if (enum_popcount_byte[i] == p-&gt;rows[row])</span></span>
<span id="cb29-364"><a href="#cb29-364"></a><span class="co">        {</span></span>
<span id="cb29-365"><a href="#cb29-365"></a><span class="co">        uint64_t move = (uint64_t)i &lt;&lt; (8*row);</span></span>
<span id="cb29-366"><a href="#cb29-366"></a></span>
<span id="cb29-367"><a href="#cb29-367"></a><span class="co">        // ensure there&#39;s no overlap with walls/monsters/treasures</span></span>
<span id="cb29-368"><a href="#cb29-368"></a><span class="co">        if ((move &amp; (p-&gt;monsters | p-&gt;treasures)) != 0)</span></span>
<span id="cb29-369"><a href="#cb29-369"></a><span class="co">            continue;</span></span>
<span id="cb29-370"><a href="#cb29-370"></a></span>
<span id="cb29-371"><a href="#cb29-371"></a><span class="co">        solve(p, row+1, b + move);</span></span>
<span id="cb29-372"><a href="#cb29-372"></a></span>
<span id="cb29-373"><a href="#cb29-373"></a><span class="co">        }</span></span>
<span id="cb29-374"><a href="#cb29-374"></a><span class="co">    */</span></span>
<span id="cb29-375"><a href="#cb29-375"></a></span>
<span id="cb29-376"><a href="#cb29-376"></a>    <span class="dt">int</span> tgt <span class="op">=</span> p<span class="op">-&gt;</span>rows<span class="op">[</span>row<span class="op">];</span></span>
<span id="cb29-377"><a href="#cb29-377"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> v <span class="op">=</span> enum_byte_idx<span class="op">[</span>tgt<span class="op">];</span> v <span class="op">&lt;</span> enum_byte_idx<span class="op">[</span>tgt<span class="op">+</span><span class="dv">1</span><span class="op">];</span> v<span class="op">++)</span></span>
<span id="cb29-378"><a href="#cb29-378"></a>    <span class="op">{</span></span>
<span id="cb29-379"><a href="#cb29-379"></a>        <span class="dt">uint64_t</span> move <span class="op">=</span> <span class="op">(</span><span class="dt">uint64_t</span><span class="op">)</span>enum_byte<span class="op">[</span>v<span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="op">(</span><span class="dv">8</span><span class="op">*</span>row<span class="op">);</span></span>
<span id="cb29-380"><a href="#cb29-380"></a></span>
<span id="cb29-381"><a href="#cb29-381"></a>        <span class="co">// ensure there&#39;s no overlap with walls/monsters/treasures</span></span>
<span id="cb29-382"><a href="#cb29-382"></a>        <span class="cf">if</span> <span class="op">((</span>move <span class="op">&amp;</span> <span class="op">(</span>p<span class="op">-&gt;</span>monsters <span class="op">|</span> p<span class="op">-&gt;</span>treasures<span class="op">))</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb29-383"><a href="#cb29-383"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb29-384"><a href="#cb29-384"></a></span>
<span id="cb29-385"><a href="#cb29-385"></a>        solve<span class="op">(</span>p<span class="op">,</span> row<span class="op">+</span><span class="dv">1</span><span class="op">,</span> b <span class="op">+</span> move<span class="op">);</span></span>
<span id="cb29-386"><a href="#cb29-386"></a>    <span class="op">}</span></span>
<span id="cb29-387"><a href="#cb29-387"></a><span class="op">}</span></span>
<span id="cb29-388"><a href="#cb29-388"></a></span>
<span id="cb29-389"><a href="#cb29-389"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb29-390"><a href="#cb29-390"></a><span class="op">{</span></span>
<span id="cb29-391"><a href="#cb29-391"></a>    <span class="co">/*</span></span>
<span id="cb29-392"><a href="#cb29-392"></a><span class="co">    map monsters = {</span></span>
<span id="cb29-393"><a href="#cb29-393"></a><span class="co">        0, 0, 1, 0, 1, 0, 0, 0,</span></span>
<span id="cb29-394"><a href="#cb29-394"></a><span class="co">        0, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span id="cb29-395"><a href="#cb29-395"></a><span class="co">        0, 0, 0, 0, 0, 0, 0, 1,</span></span>
<span id="cb29-396"><a href="#cb29-396"></a><span class="co">        1, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span id="cb29-397"><a href="#cb29-397"></a><span class="co">        0, 0, 0, 0, 0, 0, 0, 1,</span></span>
<span id="cb29-398"><a href="#cb29-398"></a><span class="co">        1, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span id="cb29-399"><a href="#cb29-399"></a><span class="co">        0, 0, 0, 0, 0, 0, 0, 0,</span></span>
<span id="cb29-400"><a href="#cb29-400"></a><span class="co">        0, 0, 0, 1, 0, 1, 0, 0,</span></span>
<span id="cb29-401"><a href="#cb29-401"></a><span class="co">    };</span></span>
<span id="cb29-402"><a href="#cb29-402"></a><span class="co">    */</span></span>
<span id="cb29-403"><a href="#cb29-403"></a></span>
<span id="cb29-404"><a href="#cb29-404"></a>    map monsters <span class="op">=</span> <span class="op">{</span> <span class="op">[</span><span class="dv">5</span><span class="op">]</span> <span class="op">=</span> <span class="dv">1</span> <span class="op">};</span></span>
<span id="cb29-405"><a href="#cb29-405"></a>    problem test <span class="op">=</span> <span class="op">{</span></span>
<span id="cb29-406"><a href="#cb29-406"></a>       <span class="op">.</span>rows <span class="op">=</span> <span class="op">{</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">6</span> <span class="op">},</span></span>
<span id="cb29-407"><a href="#cb29-407"></a>       <span class="op">.</span>columns <span class="op">=</span> <span class="op">{</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">6</span> <span class="op">}</span></span>
<span id="cb29-408"><a href="#cb29-408"></a>    <span class="op">};</span></span>
<span id="cb29-409"><a href="#cb29-409"></a>    test<span class="op">.</span>monsters <span class="op">=</span> map_to_board<span class="op">(</span>monsters<span class="op">);</span></span>
<span id="cb29-410"><a href="#cb29-410"></a>    </span>
<span id="cb29-411"><a href="#cb29-411"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">256</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb29-412"><a href="#cb29-412"></a>        enum_popcount_byte<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> popcount<span class="op">(</span>i<span class="op">);</span></span>
<span id="cb29-413"><a href="#cb29-413"></a></span>
<span id="cb29-414"><a href="#cb29-414"></a>    problem <span class="op">*</span>problems<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb29-415"><a href="#cb29-415"></a>        <span class="op">&amp;</span>p1<span class="op">,</span> <span class="op">&amp;</span>p2<span class="op">,</span> <span class="op">&amp;</span>p3<span class="op">,</span> </span>
<span id="cb29-416"><a href="#cb29-416"></a>        <span class="op">&amp;</span>p4<span class="op">,</span> <span class="op">&amp;</span>p5<span class="op">,</span> <span class="op">&amp;</span>p6<span class="op">,</span> </span>
<span id="cb29-417"><a href="#cb29-417"></a>        <span class="op">&amp;</span>p7<span class="op">,</span> <span class="op">&amp;</span>p8<span class="op">,</span> <span class="op">&amp;</span>p9</span>
<span id="cb29-418"><a href="#cb29-418"></a>    <span class="op">};</span></span>
<span id="cb29-419"><a href="#cb29-419"></a></span>
<span id="cb29-420"><a href="#cb29-420"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">9</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb29-421"><a href="#cb29-421"></a>    <span class="op">{</span></span>
<span id="cb29-422"><a href="#cb29-422"></a>        printf<span class="op">(</span><span class="st">&quot;Solving problem %d</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> i<span class="op">);</span></span>
<span id="cb29-423"><a href="#cb29-423"></a>        print_board<span class="op">(</span>problems<span class="op">[</span>i<span class="op">],</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb29-424"><a href="#cb29-424"></a>        solve<span class="op">(</span>problems<span class="op">[</span>i<span class="op">],</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb29-425"><a href="#cb29-425"></a>    <span class="op">}</span></span>
<span id="cb29-426"><a href="#cb29-426"></a><span class="op">}</span></span></code></pre></div>
<p></div></p>
</div>
<!-- </div> -->
</div>

<div class="ui inverted vertical footer segment">
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Licence Creative Commons" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
Marc de Falco
</div>
  </body>
</html>
